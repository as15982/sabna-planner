<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>Sabah Travel Companion</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Noto+Serif+TC:wght@500;700;900&display=swap" rel="stylesheet">

    <!-- Babel for JSX compilation in browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              sabah: {
                bg: '#F9F9F7',       
                yellow: '#F3C969',   
                orange: '#F26B3A',   
                blue: '#0077BE',     
                lightblue: '#89CFF0',
                green: '#508A75',    
                dark: '#2D3436',
                gray: '#A0A0A0'
              }
            },
            fontFamily: {
              serif: ['"Noto Serif TC"', 'serif'],
              sans: ['"Noto Sans TC"', 'sans-serif'],
            },
            boxShadow: {
              'soft': '0 10px 40px -10px rgba(0,0,0,0.08)',
              'card': '0 4px 20px -2px rgba(0,0,0,0.05)'
            }
          }
        }
      }
    </script>

    <style>
      body {
        font-family: 'Noto Sans TC', sans-serif;
        background-color: #111827;
        overscroll-behavior-y: none;
        margin: 0;
        padding: 0;
      }
      .no-scrollbar::-webkit-scrollbar { display: none; }
      .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
      
      .animate-fade-in { animation: fadeIn 0.5s ease-out; }
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }

      .pt-safe { padding-top: env(safe-area-inset-top, 20px); }
      .pb-safe { padding-bottom: env(safe-area-inset-bottom, 20px); }

      /* Custom Map Marker Styles */
      .custom-user-location div { animation: pulse-blue 2s infinite; }
      @keyframes pulse-blue {
        0% { box-shadow: 0 0 0 0 rgba(0, 119, 190, 0.7); }
        70% { box-shadow: 0 0 0 10px rgba(0, 119, 190, 0); }
        100% { box-shadow: 0 0 0 0 rgba(0, 119, 190, 0); }
      }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/",
    "lucide-react": "https://esm.sh/lucide-react@^0.561.0",
    "react-leaflet": "https://esm.sh/react-leaflet@^5.0.0",
    "leaflet": "https://esm.sh/leaflet@^1.9.4",
    "react-router-dom": "https://esm.sh/react-router-dom@^7.10.1"
  }
}
</script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
      // Import Dependencies from esm.sh
      import React, { useState, useEffect, useRef, useMemo } from 'https://esm.sh/react@18.2.0';
      import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';
      import { HashRouter } from 'https://esm.sh/react-router-dom@6.22.3?external=react,react-dom';
      import L from 'https://esm.sh/leaflet@1.9.4';
      import { 
        Calendar, Map as MapIcon, Wallet, ShoppingBag, Info, Cloud, Sun, CloudRain,
        MapPin, Clock, Plane, ArrowRight, Pencil, Check, X, ArrowDown, GripVertical, Image as ImageIcon,
        Plus, Coffee, Car, Home, ArrowRightLeft, CreditCard, Banknote, Users, Trash2,
        Star, AlertTriangle, ChevronDown, ChevronUp, Phone, Plug, FileText, User, Heart
      } from 'https://esm.sh/lucide-react@0.363.0?external=react';

      // ----------------------------------------------------------------------
      // Constants & Data
      // ----------------------------------------------------------------------
      const EXCHANGE_RATE = 7.5;

      const LOCATIONS = {
        BKI_AIRPORT: { lat: 5.9375, lng: 116.0510, name: "‰∫ûÂ∫áÂúãÈöõÊ©üÂ†¥ (BKI)", url: "https://maps.app.goo.gl/ePJZ5U5xeFCmF2hU8" },
        JESSELTON_QUAY: { lat: 5.9904, lng: 116.0798, name: "Jesselton Quay (JQ)", url: "https://maps.app.goo.gl/3R1xZLhLTuicD3GB6" },
        BORENOS_CHICKEN: { lat: 5.9760, lng: 116.0738, name: "Borenos Fried Chicken", url: "https://maps.app.goo.gl/TxwxbFrYLVCmYscd8" },
        FOOK_YUEN_GAYA: { lat: 5.9845, lng: 116.0775, name: "ÂØåÊ∫êËå∂È§êÂª≥ Fook Yuen", url: "https://maps.app.goo.gl/EuUbbkmhpq9Sqvrk9" },
        YEE_FUNG_LAKSA: { lat: 5.9830, lng: 116.0770, name: "ÊÄ°Ë±êËå∂ÂÆ§ Yee Fung Laksa", url: "https://maps.app.goo.gl/WnxZrPhzcoAmS2GNA" },
        WISMA_MERDEKA: { lat: 5.9856, lng: 116.0777, name: "Wisma Merdeka", url: "https://maps.app.goo.gl/Z1wmwJvYJyEGGrAM9" },
        JESSELTON_POINT: { lat: 5.9890, lng: 116.0780, name: "Jesselton Point Á¢ºÈ†≠", url: "https://maps.app.goo.gl/V9jC4SENVnXqVkgd7" },
        MANUKAN_ISLAND: { lat: 5.9644, lng: 116.0076, name: "Manukan È¶¨Âä™Âπ≤Â≥∂", url: "https://maps.app.goo.gl/2YudfdqDXmGzBn5H6" },
        SAPI_ISLAND: { lat: 5.9606, lng: 116.0048, name: "Sapi Ê≤ôÊØîÂ≥∂", url: "https://maps.app.goo.gl/EepQ76LKkaCKMedr7" },
        YU_KEE_BAK_KUT_TEH: { lat: 5.9840, lng: 116.0772, name: "‰ΩëË®òËÇâÈ™®Ëå∂ Yu Kee", url: "https://maps.app.goo.gl/91JKY3SXBkZMh5KP6" },
        SIN_KEE_BAK_KUT_TEH: { lat: 5.9825, lng: 116.0770, name: "Êñ∞Ë®òËÇâÈ™®Ëå∂ Sin Kee", url: "https://maps.app.goo.gl/aAfNCokREo4Ef5PCA" },
        API_API_NIGHT_MARKET: { lat: 5.9835, lng: 116.0772, name: "Âä†ÈõÖË°óÂ§úÂ∏Ç", url: "https://maps.app.goo.gl/XAuWddgRy8R4Qoj69" },
        WOO_CAFE: { lat: 5.9818, lng: 116.0785, name: "Woo! Cafe", url: "https://maps.app.goo.gl/XS1iXNaWkPyEPGcy7" },
        GUANS_KOPITIAM: { lat: 5.9835, lng: 116.0775, name: "Ê∫êËå∂ÂÆ§ Guan's Kopitiam", url: "https://maps.app.goo.gl/KNiTh3YnwaHwHHy18" },
        UMS_MOSQUE: { lat: 6.0367, lng: 116.1186, name: "Ê≤ôÂ∑¥Â§ßÂ≠∏Á≤âÁ¥ÖÊ∏ÖÁúüÂØ∫", url: "https://maps.app.goo.gl/LpWEkTrs3vzVogNy8" },
        JIA_XIANG_LINTAS: { lat: 5.9490, lng: 116.0920, name: "ÂÆ∂È¶ôÁîüËÇâÈ∫µ", url: "https://maps.app.goo.gl/dH28jaQhk65kTVbc6" },
        IMAGO_MALL: { lat: 5.9705, lng: 116.0667, name: "Imago Shopping Mall", url: "https://maps.app.goo.gl/Xaix69z83tSxYWX79" },
        TANJUNG_ARU_BEACH: { lat: 5.9482, lng: 116.0447, name: "‰∏πÁµ®‰∫ûË∑ØÊµ∑ÁÅò Beach 2", url: "https://maps.app.goo.gl/bDrPDVcMoYZ49HvJA" },
        WELCOME_SEAFOOD: { lat: 5.9765, lng: 116.0740, name: "Â§ßËåÑ‰æÜÊµ∑ÈÆÆ", url: "https://maps.app.goo.gl/yhW1Uk42XVnLD8oQ9" },
        KAMA_SPA: { lat: 5.9815, lng: 116.0782, name: "Kama'A Spa", url: "https://maps.app.goo.gl/Mxi3rzqiDZf4rFFCA" }
      };

      const INITIAL_ITINERARY = [
        {
          date: '2026-01-09',
          weatherTemp: 27,
          weatherCondition: 'Cloudy',
          bgImage: 'https://i.pinimg.com/736x/a4/ae/3f/a4ae3f8d0c49e9cbf2e725a42e6d24ba.jpg', // D1
          flight: {
            departureTime: '19:15',
            departureCode: 'TPE',
            departureAirport: 'Âè∞ÁÅ£Ê°ÉÂúíÂúãÈöõÊ©üÂ†¥ ÔΩúT1Ëà™Âªà',
            arrivalTime: '22:50',
            arrivalCode: 'BKI',
            arrivalAirport: 'Âì•Êâì‰∫¨ÈÇ£Â∑¥È≠ØÂúãÈöõÊ©üÂ†¥ÔΩúT1Ëà™Âªà',
            airline: 'È¶¨‰æÜË•ø‰∫û‰∫ûÊ¥≤Ëà™Á©∫ÂÖ¨Âè∏ AK1511',
            flightNumber: 'AK1511',
            aircraft: 'Á∂ìÊøüËâô Á©∫‰∏≠Â∑¥Â£´ A320-212'
          },
          items: [
            { id: '1-1', time: '22:30', duration: 40, activity: 'ÊäµÈÅî‰∫ûÂ∫áÂúãÈöõÊ©üÂ†¥ (BKI)', location: 'Kota Kinabalu International Airport', coords: LOCATIONS.BKI_AIRPORT, type: 'transport', travelTime: 'Grab 20ÂàÜ' },
            { id: '1-2', time: '23:30', duration: 20, activity: 'ÊäµÈÅî‰ΩèÂÆø Jesselton Quay (JQ)', location: 'Jesselton Quay, Jalan Tun Fuad Stephens', coords: LOCATIONS.JESSELTON_QUAY, type: 'relax', travelTime: 'Êï¥ÁêÜË°åÊùé' },
            { id: '1-3', time: '23:50', duration: 60, activity: 'ÂÆµÂ§ú (‰∫åÈÅ∏‰∏Ä)', location: 'Swipe to view options', coords: LOCATIONS.BORENOS_CHICKEN, type: 'food', options: [
              { activity: 'Borenos Fried Chicken', location: 'Lot G23, Kompleks Asia City', coords: LOCATIONS.BORENOS_CHICKEN, notes: 'Âú®Âú∞Â•ΩÂêÉÁÇ∏ÈõûÔºåÈñãÂà∞ÂçäÂ§ú', imageUrl: 'https://images.unsplash.com/photo-1626082927389-6cd097cdc6ec?q=80&w=500&auto=format&fit=crop' },
              { activity: 'ÂØåÊ∫êËå∂È§êÂª≥ Fook Yuen', location: '53, Jalan Gaya', coords: LOCATIONS.FOOK_YUEN_GAYA, notes: 'ÂíñÊ§∞ÂêêÂè∏„ÄÅÊãâËå∂ÔºåÈñãÂà∞ÂæàÊôö', imageUrl: 'https://images.unsplash.com/photo-1589301760588-441b6f5e71a9?q=80&w=500&auto=format&fit=crop' }
            ]}
          ]
        },
        {
          date: '2026-01-10',
          weatherTemp: 31,
          weatherCondition: 'Sunny',
          bgImage: 'https://i.pinimg.com/1200x/39/b4/aa/39b4aa96ca7fe7de41f28623af1eaf8b.jpg', // D2
          items: [
            { id: '2-0', time: '09:00', duration: 0, activity: 'Âæû‰ΩèÂÆøÂá∫Áôº', location: 'Jesselton Quay (JQ)', coords: LOCATIONS.JESSELTON_QUAY, type: 'transport', travelTime: 'Grab 15ÂàÜ' },
            { id: '2-1', time: '09:15', duration: 45, activity: 'Êó©È§êÔºöÊÄ°Ë±êËå∂ÂÆ§ Yee Fung Laksa', location: '127, Jalan Gaya', coords: LOCATIONS.YEE_FUNG_LAKSA, type: 'food', notes: 'ÂøÖÈªûÔºöÂèªÊ≤ô Laksa„ÄÅÊ≤ôÁÖ≤ÈõûÈ£Ø', imageUrl: 'https://images.unsplash.com/photo-1632204655513-3392e2124508?q=80&w=500&auto=format&fit=crop', travelTime: 'Ê≠•Ë°å 5ÂàÜ' },
            { id: '2-2', time: '10:00', duration: 30, activity: 'ÊèõÈå¢ÔºöWisma Merdeka', location: 'Wisma Merdeka, Jalan Tun Razak', coords: LOCATIONS.WISMA_MERDEKA, type: 'activity', notes: 'ÂåØÁéáÊúÄÂ•ΩÔºåÊèõÂÆåÁõ¥Êé•Ëµ∞ÂéªÊóÅÈÇäÁ¢ºÈ†≠', travelTime: 'Ê≠•Ë°å 5ÂàÜ' },
            { id: '2-3', time: '10:30', duration: 30, activity: 'Âá∫Êµ∑ÔºöJesselton Point Á¢ºÈ†≠', location: 'Jesselton Point Ferry Terminal', coords: LOCATIONS.JESSELTON_POINT, type: 'transport', notes: 'Ë≥ºÁ•®ÔºöTwo Islands - Sapi + Manukan', travelTime: 'ËàπÁ®ã 20ÂàÜ' },
            { id: '2-4a', time: '11:00', duration: 120, activity: 'È¶¨Âä™Âπ≤Â≥∂ Manukan Island', location: 'Tunku Abdul Rahman Park', coords: LOCATIONS.MANUKAN_ISLAND, type: 'activity', notes: '‰∫´ÂèóÈôΩÂÖâÊ≤ôÁÅò', travelTime: 'ÊèõÂ≥∂ËàπÁ®ã' },
            { id: '2-4b', time: '13:00', duration: 120, activity: 'Ê≤ôÊØîÂ≥∂ Sapi Island', location: 'Tunku Abdul Rahman Park', coords: LOCATIONS.SAPI_ISLAND, type: 'activity', notes: 'Ê∞¥Ë≥™ËºÉÊ∏ÖÊæàÔºåÈÅ©ÂêàÊµÆÊΩõ', travelTime: 'ËàπÁ®ãËøîÂõû' },
            { id: '2-5', time: '19:00', duration: 75, activity: 'ÊôöÈ§êÔºöËÇâÈ™®Ëå∂ (‰∫åÈÅ∏‰∏Ä)', location: 'Swipe to view options', coords: LOCATIONS.YU_KEE_BAK_KUT_TEH, type: 'food', options: [
               { activity: '‰ΩëË®òËÇâÈ™®Ëå∂ Yu Kee', location: '7, Jalan Gaya', coords: LOCATIONS.YU_KEE_BAK_KUT_TEH, notes: 'Ëó•ËÜ≥Âë≥ÈáçÔºåÁ¢óË£ù', imageUrl: 'https://images.unsplash.com/photo-1543363363-b8cf4b306b6f?q=80&w=500&auto=format&fit=crop' },
               { activity: 'Êñ∞Ë®òËÇâÈ™®Ëå∂ Sin Kee', location: '26, Jalan Pantai', coords: LOCATIONS.SIN_KEE_BAK_KUT_TEH, notes: 'ÊπØÈ†≠ÊøÉÈÉÅÔºåÁ†ÇÈçãË£ù', imageUrl: 'https://images.unsplash.com/photo-1627916508000-0df9a7978e5f?q=80&w=500&auto=format&fit=crop' }
            ], travelTime: 'Ê≠•Ë°å 3ÂàÜ' },
            { id: '2-6', time: '20:15', duration: 60, activity: 'ÈÄõË°óÔºöÂä†ÈõÖË°óÂ§úÂ∏Ç', location: 'Api-Api Night Market', coords: LOCATIONS.API_API_NIGHT_MARKET, type: 'activity', notes: 'ÈÄ±‰∫îÈÄ±ÂÖ≠ÈôêÂÆöÂ§úÂ∏Ç' }
          ]
        },
        {
          date: '2026-01-11',
          weatherTemp: 29,
          weatherCondition: 'Cloudy',
          bgImage: 'https://i.pinimg.com/1200x/fd/d5/18/fdd5185cbab77d2e1abf50b54b1fc656.jpg', // D3
          items: [
            { id: '3-0', time: '10:30', duration: 0, activity: 'Âæû‰ΩèÂÆøÂá∫Áôº', location: 'Jesselton Quay (JQ)', coords: LOCATIONS.JESSELTON_QUAY, type: 'transport', travelTime: 'Grab 15ÂàÜ' },
            { id: '3-1', time: '10:45', duration: 90, activity: 'Á∂≤ÁæéÊó©ÂçàÈ§ê (‰∫åÈÅ∏‰∏Ä)', location: 'Swipe to view options', coords: LOCATIONS.WOO_CAFE, type: 'food', options: [
              { activity: 'Woo! Cafe', location: '25, Lorong Dewan', coords: LOCATIONS.WOO_CAFE, notes: 'Ê§çÁâ©Á≥ªÁ∂≤ÁæéÈ¢®ÔºåÁæ©Â§ßÂà©È∫µ„ÄÅÊó©ÂçàÈ§êÂ•ΩÂêÉ', imageUrl: 'https://images.unsplash.com/photo-1554118811-1e0d58224f24?q=80&w=500&auto=format&fit=crop' },
              { activity: 'Guan\'s Kopitiam', location: 'Jalan Gaya', coords: LOCATIONS.GUANS_KOPITIAM, notes: 'ÊúâÂÜ∑Ê∞£ÁöÑÂæ©Âè§È¢®ÔºåÊé®ÂíñÊ§∞ÂêêÂè∏„ÄÅÁ¥ÖÂíñÂì©Èõû', imageUrl: 'https://images.unsplash.com/photo-1559403842-70b925b4be46?q=80&w=500&auto=format&fit=crop' }
            ], travelTime: 'ËªäÁ®ã 90ÂàÜ' },
            { id: '3-2', time: '13:30', duration: 360, activity: 'Èï∑ÈºªÁå¥ & Ëû¢ÁÅ´Ëü≤‰πãÊóÖ', location: 'Kawa Kawa / Weston (Pickup at JQ)', coords: LOCATIONS.JESSELTON_QUAY, type: 'activity', notes: 'ÊóÖË°åÁ§æÂ∞àËªäÊé•ÈÄÅÔºåË®òÂæóÂ∏∂Èò≤ËöäÊ∂≤', travelTime: 'ËªäÁ®ã 90ÂàÜ' },
            { id: '3-3', time: '21:30', duration: 60, activity: 'ÂÆµÂ§ú (Ë¶ñÈ´îÂäõÊ±∫ÂÆö)', location: 'Jesselton Quay / ÂØåÊ∫ê', coords: LOCATIONS.FOOK_YUEN_GAYA, type: 'food' }
          ]
        },
        {
          date: '2026-01-12',
          weatherTemp: 32,
          weatherCondition: 'Sunny',
          bgImage: 'https://i.pinimg.com/1200x/3d/2b/b9/3d2bb9a9e3ebc71f0b73692f93e19633.jpg', // D4
          items: [
            { id: '4-0', time: '10:40', duration: 0, activity: 'Âæû‰ΩèÂÆøÂá∫Áôº', location: 'Jesselton Quay (JQ)', coords: LOCATIONS.JESSELTON_QUAY, type: 'transport', travelTime: 'Grab 20ÂàÜ' },
            { id: '4-1', time: '11:00', duration: 60, activity: 'ÊôØÈªûÔºöÊ≤ôÂ∑¥Â§ßÂ≠∏Á≤âÁ¥ÖÊ∏ÖÁúüÂØ∫', location: 'Jalan UMS (UMS Pink Mosque)', coords: LOCATIONS.UMS_MOSQUE, type: 'activity', notes: 'Ë®òÂæóÁ©øËëóÂæóÈ´îÊàñÁßüÂÄüÈï∑Ë¢çÔºåÁ≤âÁ¥ÖÁâÜÈù¢Ë∂ÖÂ•ΩÊãç', travelTime: 'Grab 20ÂàÜ' },
            { id: '4-2', time: '12:30', duration: 60, activity: 'ÂçàÈ§êÔºöÂÆ∂È¶ôÁîüËÇâÈ∫µ', location: 'Lintas Plaza', coords: LOCATIONS.JIA_XIANG_LINTAS, type: 'food', notes: 'ÊπØÈ†≠ÈÆÆÁîúÔºåËÇâÁâáÊªëÂ´©', imageUrl: 'https://images.unsplash.com/photo-1626809804863-7c85172088f1?q=80&w=500&auto=format&fit=crop', travelTime: 'Grab 15ÂàÜ' },
            { id: '4-3', time: '14:00', duration: 180, activity: 'Ë≥ºÁâ©ÔºöImago Shopping Mall', location: 'KK Times Square', coords: LOCATIONS.IMAGO_MALL, type: 'activity', notes: 'Ë≤∑ Bata„ÄÅPadini„ÄÅË∂ÖÂ∏Ç‰º¥ÊâãÁ¶Æ (3Â∞èÊôÇ)', travelTime: 'Grab 15ÂàÜ' },
            { id: '4-4', time: '17:30', duration: 90, activity: 'Â§ïÈôΩÔºö‰∏πÁµ®‰∫ûË∑ØÊµ∑ÁÅò', location: 'Tanjung Aru Beach', coords: LOCATIONS.TANJUNG_ARU_BEACH, type: 'relax', notes: '‰∏ñÁïå‰∏âÂ§ßÂ§ïÈôΩ‰πã‰∏ÄÔºåÂÆö‰Ωç Beach 2 ÁÇ∫‰Ω≥', travelTime: 'Grab 15ÂàÜ' },
            { id: '4-5', time: '19:30', duration: 90, activity: 'ÊôöÈ§êÔºöÂ§ßËåÑ‰æÜÊµ∑ÈÆÆ', location: 'Kompleks Asia City', coords: LOCATIONS.WELCOME_SEAFOOD, type: 'food', notes: 'ÂøÖÈªûÔºöÊøïÂ•∂Ê≤πËÄÅËôéËù¶„ÄÅÈππËõãÈªÉÁÇíËüπ„ÄÅÊ°îÂ≠êÂÜ∞', imageUrl: 'https://images.unsplash.com/photo-1565557623262-b51c2513a641?q=80&w=500&auto=format&fit=crop', travelTime: 'Ê≠•Ë°å 5ÂàÜ' },
            { id: '4-6', time: '21:30', duration: 30, activity: 'ÊåâÊë©ÔºöKama‚Äô A Spa', location: '15, Jalan Dewan', coords: LOCATIONS.KAMA_SPA, type: 'relax', notes: 'ÊîæÈ¨ÜÂÆåÂõû JQ ÊâìÂåÖË°åÊùé' }
          ]
        },
        {
          date: '2026-01-13',
          weatherTemp: 26,
          weatherCondition: 'Rain',
          bgImage: 'https://i.pinimg.com/736x/7e/22/3f/7e223f12849b463bc9ce8caf19b59e53.jpg', // D5
          flight: {
            departureTime: '07:40',
            departureCode: 'BKI',
            departureAirport: 'Âì•Êâì‰∫¨ÈÇ£Â∑¥È≠ØÂúãÈöõÊ©üÂ†¥ÔΩúT1Ëà™Âªà',
            arrivalTime: '10:55',
            arrivalCode: 'TPE',
            arrivalAirport: 'Âè∞ÁÅ£Ê°ÉÂúíÂúãÈöõÊ©üÂ†¥ÔΩúT1Ëà™Âªà',
            airline: 'È¶¨‰æÜË•ø‰∫û‰∫ûÊ¥≤Ëà™Á©∫ÂÖ¨Âè∏ AK1510',
            flightNumber: 'AK1510',
            aircraft: 'Á∂ìÊøüËâô Á©∫‰∏≠Â∑¥Â£´ A320-212'
          },
          items: [
            { id: '5-1', time: '04:45', duration: 15, activity: 'Ëµ∑Â∫ä & ÈÄÄÊàø', location: 'Jesselton Quay', coords: LOCATIONS.JESSELTON_QUAY, type: 'relax', travelTime: 'Grab 20ÂàÜ' },
            { id: '5-2', time: '05:00', duration: 0, activity: 'Âá∫ÁôºÂâçÂæÄ‰∫ûÂ∫áÊ©üÂ†¥', location: 'Kota Kinabalu International Airport', coords: LOCATIONS.BKI_AIRPORT, type: 'transport', notes: 'Âè´ GrabÔºå07:00 È£õÊ©üËµ∑È£õ ‚úàÔ∏è ÂõûÂÆ∂' }
          ]
        }
      ];

      const INITIAL_EXPENSES = [];

      const INITIAL_SHOPPING_LOCATIONS = [
        { id: 'sl-1', name: 'Wisma Merdeka', description: 'ÊúÄ‰Ω≥ÊèõÂåØÂú∞ÈªûÔºå‰πüÊúâË≥£Á¥ÄÂøµÂìÅ', type: 'ÊèõÂåØ & Á¥ÄÂøµÂìÅ', googleMapQuery: 'Wisma Merdeka Kota Kinabalu', imageUrl: 'https://images.unsplash.com/photo-1574902998399-56d11bd85721?q=80&w=500' },
        { id: 'sl-2', name: 'Imago Shopping Mall', description: '‰∫ûÂ∫áÊúÄÂ§ßÂïÜÂ†¥ÔºåÂøÖË≤∑ Padini, Bata, Fipper, Eureka', type: 'Ë≥ºÁâ©‰∏≠ÂøÉ', googleMapQuery: 'Imago Shopping Mall Kota Kinabalu', imageUrl: 'https://images.unsplash.com/photo-1519567241046-7f570eee3d9f?q=80&w=500' },
        { id: 'sl-3', name: 'Gaya Street Market', description: 'ÈÄ±Êó•Â∏ÇÈõÜ / ÈÄ±‰∫îÂÖ≠Â§úÂ∏ÇÔºåÊâãÂ∑•ËóùÂìÅÂ§ö', type: 'Áï∂Âú∞Â∏ÇÈõÜ', googleMapQuery: 'Gaya Street Kota Kinabalu', imageUrl: 'https://images.unsplash.com/photo-1533900298318-6b8da08a523e?q=80&w=500' },
        { id: 'sl-4', name: 'Suria Sabah', description: '‰ΩçÊñºÊµ∑ÈÇäÁöÑË≥ºÁâ©‰∏≠ÂøÉÔºåÊúâÁÑ°ÊïµÊµ∑ÊôØÔºåË∂ÖÂ∏ÇÂ•ΩË≤∑', type: 'Ë≥ºÁâ©‰∏≠ÂøÉ', googleMapQuery: 'Suria Sabah Shopping Mall', imageUrl: 'https://images.unsplash.com/photo-1555529733-0e670560f7e1?q=80&w=500' },
        { id: 'sl-5', name: 'KK Plaza', description: 'Âú∞‰∏ãÂÆ§Ë∂ÖÂ∏Ç‰æøÂÆúÔºåÈÅ©ÂêàË≤∑‰º¥ÊâãÁ¶Æ', type: 'Ë∂ÖÂ∏Ç', googleMapQuery: 'KK Plaza Kota Kinabalu', imageUrl: 'https://images.unsplash.com/photo-1604719312566-b7e6012e6b17?q=80&w=500' }
      ];

      const INITIAL_SHOPPING_ITEMS = [
        { id: 'si-1', name: 'Ê≤ôÂ∑¥Á¥ÖËå∂ (Sabah Tea)', description: 'Á•ûÂ±±ÊúâÊ©üÊ†ΩÁ®ÆÔºåÂë≥ÈÅìÂñÆÁ¥î‰∏çÊæÄ„ÄÇÊé®Ëñ¶Á∂†Ëâ≤ÂåÖË£ù„ÄÇ', rating: 5, imageUrl: 'https://images.unsplash.com/photo-1597481499750-3e6b22637e12?q=80&w=500', locationHint: 'ÂêÑÂ§ßË∂ÖÂ∏Ç' },
        { id: 'si-2', name: 'ÁõäÂíå‰∏πÂçóÂíñÂï°', description: 'Ê≤ôÂ∑¥ÊúÄÂè§ËÄÅÂíñÂï°ÔºåÂøÖË≤∑„ÄåÈäÄËâ≤ÂåÖË£ù Kopi O„ÄçÔºåÁÇ≠ÁáíÂë≥È¶ôÊøÉ„ÄÇ', rating: 4, imageUrl: 'https://images.unsplash.com/photo-1559496417-e7f25cb247f3?q=80&w=500', locationHint: 'Ë∂ÖÂ∏Ç' },
        { id: 'si-3', name: 'Beryl\'s Â∑ßÂÖãÂäõ', description: 'ÂúãÂØ∂Á¥öÂ∑ßÂÖãÂäõÔºåÊé®Ëñ¶ÊèêÊãâÁ±≥ËòáÂíåÊ¶¥Êß§Âè£Âë≥„ÄÇ', rating: 5, imageUrl: 'https://images.unsplash.com/photo-1511381978829-2c287a32d18b?q=80&w=500' },
        { id: 'si-4', name: 'Eureka ÁàÜÁ±≥Ëä±', description: 'È¶¨‰æÜË•ø‰∫ûÁî¢Âú∞ÂÉπÁ¥ÑÂè∞ÁÅ£6-7Êäò„ÄÇÂè£Âë≥Ë∂ÖÂ§ö(Áï™ËåÑ/ÈÖ∏Â•∂Ê¥ãËî•)„ÄÇ', rating: 5, locationHint: 'Imago Mall Â∞àÊ´É', imageUrl: 'https://images.unsplash.com/photo-1578849278619-e73505e9610f?q=80&w=500' },
        { id: 'si-5', name: 'A1 ËÇâÈ™®Ëå∂ÂåÖ', description: '‚ö†Ô∏è Âè™ËÉΩË≤∑Á¥îËó•ÊùêÁ≤â/È¶ôÊñôÂåÖÔºÅÂê´Ë±¨ËÇâÊàêÂàÜÁ¶ÅÂ∏∂ÂõûÂè∞(ÁΩ∞20Ëê¨)„ÄÇ', rating: 4, imageUrl: 'https://images.unsplash.com/photo-1596040033229-a9821ebd058d?q=80&w=500' },
        { id: 'si-6', name: 'Kaya ÂíñÊ§∞ÈÜ¨', description: 'Â¶ÇÊûúÊÑõ‰∏äÂØåÊ∫êÁöÑÂêêÂè∏ÔºåË≤∑ÁΩêÈ†≠Ë£ùÂõûÂÆ∂ÊäπÂêêÂè∏„ÄÇ', rating: 3, imageUrl: 'https://images.unsplash.com/photo-1589301760588-441b6f5e71a9?q=80&w=500' },
        { id: 'si-7', name: 'Fipper Â§æËÖ≥Êãñ', description: 'ÂúãÊ∞ëÊãñÈûã(Â§ßË±°Ê®ôË™å)„ÄÇÊ©°ËÜ†ÊùêË≥™Â•ΩÁ©øÈò≤ÊªëÔºåÈ°èËâ≤ÁπΩÁ¥õ„ÄÇ', rating: 5, priceEstimate: 'RM 20-40', locationHint: 'Imago Mall', imageUrl: 'https://images.unsplash.com/photo-1562124638-724e13052aaf?q=80&w=500' },
        { id: 'si-8', name: 'Padini (Vincci)', description: 'ÂúãÊ∞ëÂø´ÊôÇÂ∞ö„ÄÇVincci ÈûãÂåÖÈùûÂ∏∏‰æøÂÆúÂ•ΩÁúãÔºåÊ∂ºÈûãÂ∏∏‰∏çÂà∞Âè∞Âπ£400„ÄÇ', rating: 4, locationHint: 'Imago Mall', imageUrl: 'https://images.unsplash.com/photo-1543163521-1bf539c55dd2?q=80&w=500' },
        { id: 'si-9', name: 'Bata ÈûãÂ≠ê', description: 'Â∏Ç‰ΩîÁéáÈ´òÔºåÂÉπÊ†ºÊØîÂè∞ÁÅ£‰æøÂÆúÔºåÁ©øËµ∑‰æÜÂæàËªüÂæàËàíÊúç„ÄÇ', rating: 3, locationHint: 'Imago Mall', imageUrl: 'https://images.unsplash.com/photo-1595950653106-6c9ebd614d3a?q=80&w=500' },
        { id: 'si-10', name: 'Èï∑ÈºªÁå¥Â®ÉÂ®É', description: 'Â©ÜÁæÖÊ¥≤ÁâπÊúâÔºåÈºªÂ≠êÂ§ßÂ§ßÈÜúËêåÔºåÂæàÊúâÁ¥ÄÂøµÂÉπÂÄº„ÄÇ', rating: 4, imageUrl: 'https://images.unsplash.com/photo-1570414461014-429a4c58c1df?q=80&w=500' },
        { id: 'si-11', name: 'Ê≤ôÂ∑¥ÊâãÂ∑•ËóùÂìÅ', description: 'Á∑®ÁπîÂåÖ„ÄÅ‰∏≤Áè†ÔºåËâ≤ÂΩ©ÈÆÆË±î„ÄÇ', rating: 4, locationHint: 'Âä†ÈõÖË°óÂ∏ÇÈõÜ', imageUrl: 'https://images.unsplash.com/photo-1459416527563-3467614d9b62?q=80&w=500' },
        { id: 'si-12', name: 'The Art Attic ÊñáÂâµ', description: 'Áï∂Âú∞ËóùË°ìÂÆ∂Ë®≠Ë®àÁöÑÊòé‰ø°Áâá„ÄÅTÊÅ§„ÄÅÁ£ÅÈêµÔºåË≥™ÊÑüÂ•Ω„ÄÇ', rating: 4, imageUrl: 'https://images.unsplash.com/photo-1513519245088-0e12902e5a38?q=80&w=500' }
      ];

      // ----------------------------------------------------------------------
      // Components
      // ----------------------------------------------------------------------

      // --- EditableImage ---
      const EditableImage = ({ src, alt, className = "", onImageChange, placeholderIcon }) => {
        const fileInputRef = useRef(null);
        const pressTimer = useRef(null);
        const [isPressing, setIsPressing] = useState(false);

        const handleStart = () => {
          setIsPressing(true);
          pressTimer.current = setTimeout(() => {
            fileInputRef.current?.click();
            setIsPressing(false);
            if (navigator.vibrate) navigator.vibrate(50);
          }, 800);
        };

        const handleEnd = () => {
          setIsPressing(false);
          if (pressTimer.current) clearTimeout(pressTimer.current);
        };

        const handleFileChange = (e) => {
          const file = e.target.files?.[0];
          if (file) {
            const reader = new FileReader();
            reader.onloadend = () => {
              if (typeof reader.result === 'string') onImageChange(reader.result);
            };
            reader.readAsDataURL(file);
          }
        };

        return (
          <>
            <input type="file" ref={fileInputRef} className="hidden" accept="image/*" onChange={handleFileChange} />
            <div 
              className={`relative overflow-hidden cursor-pointer select-none ${className}`}
              onTouchStart={handleStart} onTouchEnd={handleEnd} onMouseDown={handleStart} onMouseUp={handleEnd} onMouseLeave={handleEnd}
              onContextMenu={(e) => e.preventDefault()}
            >
              <div className={`absolute inset-0 bg-black/40 flex items-center justify-center transition-opacity duration-300 ${isPressing ? 'opacity-100' : 'opacity-0'} pointer-events-none`}>
                <div className="bg-white/20 backdrop-blur-md px-3 py-1 rounded-full text-white text-xs font-bold border border-white/30">Êõ¥ÊèõÂúñÁâá</div>
              </div>
              {src ? (
                <img src={src} alt={alt} className="w-full h-full object-cover pointer-events-none" onError={(e) => e.currentTarget.style.display = 'none'} />
              ) : (
                <div className="w-full h-full flex items-center justify-center text-gray-300 bg-gray-100">
                  {placeholderIcon || <ImageIcon size={24} />}
                </div>
              )}
            </div>
          </>
        );
      };

      // --- DateSelector ---
      const DateSelector = ({ days, selectedDate, onSelectDate }) => {
        return (
          <div className="w-full bg-transparent">
            <div className="flex overflow-x-auto gap-2 px-1 pb-1 no-scrollbar snap-x">
              {days.map((day) => {
                const isSelected = day.date === selectedDate;
                const [year, month, d] = day.date.split('-').map(Number);
                const dateObj = new Date(year, month - 1, d);
                const weekday = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'][dateObj.getDay()];
                return (
                  <button
                    key={day.date}
                    onClick={() => onSelectDate(day.date)}
                    className={`flex-shrink-0 flex flex-col items-center justify-center w-[42px] h-[54px] rounded-[14px] transition-all duration-300 snap-center border-[1.5px]
                    ${isSelected ? 'bg-sabah-blue border-sabah-blue text-white shadow-md shadow-blue-500/30 scale-105' : 'bg-white/80 border-transparent text-gray-500 hover:bg-white hover:border-gray-100 backdrop-blur-sm'}`}
                  >
                    <span className={`text-[8px] font-sans font-bold uppercase tracking-wider ${isSelected ? 'text-white/80' : 'text-gray-400'}`}>{weekday}</span>
                    <span className={`text-lg font-serif font-bold -mt-0.5 ${isSelected ? 'text-white' : 'text-sabah-dark'}`}>{dateObj.getDate()}</span>
                  </button>
                );
              })}
            </div>
          </div>
        );
      };

      // --- ItineraryList ---
      const ItineraryList = ({ dayPlan, onUpdate }) => {
        const [editingId, setEditingId] = useState(null);
        const dragItem = useRef(null);
        const dragOverItem = useRef(null);
        const timerRef = useRef(null);
        const [pressProgress, setPressProgress] = useState(0);
        const progressIntervalRef = useRef(null);

        const handleSaveNote = (itemId, newNote, optionIndex) => {
          const updatedItems = dayPlan.items.map(item => {
            if (item.id === itemId) {
              if (optionIndex !== undefined && item.options) {
                const newOptions = [...item.options];
                newOptions[optionIndex] = { ...newOptions[optionIndex], notes: newNote };
                return { ...item, options: newOptions };
              }
              return { ...item, notes: newNote };
            }
            return item;
          });
          onUpdate({ ...dayPlan, items: updatedItems });
        };

        const handleSaveImage = (itemId, newImage, optionIndex) => {
          const updatedItems = dayPlan.items.map(item => {
            if (item.id === itemId) {
              if (optionIndex !== undefined && item.options) {
                const newOptions = [...item.options];
                newOptions[optionIndex] = { ...newOptions[optionIndex], imageUrl: newImage };
                return { ...item, options: newOptions };
              }
              return { ...item, imageUrl: newImage };
            }
            return item;
          });
          onUpdate({ ...dayPlan, items: updatedItems });
        };

        const handleDragStart = (e, index) => {
          dragItem.current = index;
          setEditingId(null);
        };
        const handleDragEnter = (e, index) => dragOverItem.current = index;
        const handleDragEnd = () => {
          if (dragItem.current !== null && dragOverItem.current !== null && dragItem.current !== dragOverItem.current) {
            const _items = [...dayPlan.items];
            const dragged = _items.splice(dragItem.current, 1)[0];
            _items.splice(dragOverItem.current, 0, dragged);
            // Re-calc logic omitted for brevity, keeping simple reorder
            onUpdate({ ...dayPlan, items: _items });
          }
          dragItem.current = null;
          dragOverItem.current = null;
        };

        const startLongPress = (id) => {
          if (editingId === id) return;
          setPressProgress(0);
          progressIntervalRef.current = setInterval(() => setPressProgress(o => Math.min(o + 2.5, 100)), 50);
          timerRef.current = setTimeout(() => {
            if (navigator.vibrate) navigator.vibrate(50);
            setEditingId(id);
            setPressProgress(0);
            clearInterval(progressIntervalRef.current);
          }, 2000);
        };
        const cancelLongPress = () => {
          clearTimeout(timerRef.current);
          clearInterval(progressIntervalRef.current);
          setPressProgress(0);
        };

        return (
          <div className="pb-24 animate-fade-in relative z-10 pt-4 px-6">
            {dayPlan.flight && (
              <div className="bg-white/90 backdrop-blur-md rounded-[24px] p-5 shadow-card mb-8 border border-white/50 relative overflow-hidden">
                <div className="absolute top-0 left-0 right-0 h-1.5 bg-gradient-to-r from-red-500 to-red-600"></div>
                <div className="flex justify-between items-center mb-6 mt-1">
                  <div className="flex flex-col"><span className="text-4xl font-sans font-bold text-sabah-dark">{dayPlan.flight.departureCode}</span><span className="text-2xl font-serif text-sabah-blue font-bold">{dayPlan.flight.departureTime}</span></div>
                  <div className="flex flex-col items-center flex-1 px-4 text-gray-300"><Plane size={32} className="transform -rotate-45" /><div className="w-full h-[1px] bg-gray-300 border-t border-dashed border-gray-400 mt-2"></div><span className="text-[10px] text-gray-400 font-bold mt-1">Áõ¥È£õ</span></div>
                  <div className="flex flex-col items-end"><span className="text-4xl font-sans font-bold text-sabah-dark">{dayPlan.flight.arrivalCode}</span><span className="text-2xl font-serif text-sabah-blue font-bold">{dayPlan.flight.arrivalTime}</span></div>
                </div>
                <div className="bg-gray-50/80 rounded-xl p-3 flex items-center gap-3 border border-gray-100"><div className="flex flex-col"><span className="text-xs font-bold text-sabah-dark">{dayPlan.flight.airline}</span><span className="text-[10px] text-gray-400">{dayPlan.flight.aircraft}</span></div></div>
              </div>
            )}
            
            <div className="flex justify-end mb-2">
               {editingId && <button onClick={() => setEditingId(null)} className="text-xs bg-sabah-blue text-white px-3 py-1 rounded-full shadow-sm">ÂÆåÊàêÁ∑®ËºØ</button>}
            </div>

            <div className="space-y-2">
              {dayPlan.items.map((item, index) => (
                <div key={item.id} onDragEnter={(e) => handleDragEnter(e, index)} onDragOver={(e) => e.preventDefault()} onDrop={handleDragEnd}>
                   <div className="flex gap-4">
                      <div className="flex flex-col items-center pt-1">
                        <div className={`w-12 h-12 rounded-[18px] flex items-center justify-center shadow-sm z-10 ${item.type==='food'?'bg-sabah-orange text-white':item.type==='relax'?'bg-sabah-green text-white':item.type==='transport'?'bg-sabah-yellow text-sabah-dark':'bg-sabah-blue text-white'}`}>
                          <span className="text-[11px] font-bold font-serif tracking-wider">{item.time}</span>
                        </div>
                      </div>
                      <div 
                        className={`flex-1 bg-white/85 backdrop-blur-md rounded-[24px] p-5 shadow-card border transition-all duration-300 flex flex-col gap-1 relative overflow-hidden select-none ${editingId === item.id ? 'border-sabah-blue ring-2 ring-sabah-blue/20' : 'border-white/40'}`}
                        onTouchStart={() => startLongPress(item.id)} onTouchEnd={cancelLongPress} onMouseDown={() => startLongPress(item.id)} onMouseUp={cancelLongPress} onMouseLeave={cancelLongPress}
                      >
                         {pressProgress > 0 && <div className="absolute top-0 left-0 h-1 bg-sabah-blue transition-all duration-100 ease-linear" style={{ width: `${pressProgress}%` }}></div>}
                         <div className="flex gap-4">
                            <div className="cursor-grab text-gray-300" draggable onDragStart={(e) => handleDragStart(e, index)} onMouseDown={e=>e.stopPropagation()}><GripVertical size={20} /></div>
                            <div className="flex-1">
                               <div className="flex items-center gap-1.5 text-gray-400 text-[10px] font-bold uppercase tracking-wider mb-2"><Clock size={10} />{item.type}</div>
                               <h3 className="text-lg font-serif font-bold text-sabah-dark mb-2 leading-tight">{item.activity}</h3>
                               <a href={item.coords.url} target="_blank" className="flex items-start gap-1.5 text-gray-500 text-xs hover:text-sabah-blue transition-colors mb-2"><MapPin size={12} className="mt-0.5" />{item.location}</a>
                            </div>
                            {(editingId === item.id || item.imageUrl) && (
                                <div className="w-20 h-20 flex-shrink-0 rounded-2xl shadow-sm border border-white bg-gray-50 overflow-hidden">
                                    {editingId === item.id ? <EditableImage src={item.imageUrl} alt={item.activity} onImageChange={(s) => handleSaveImage(item.id, s)} className="w-full h-full" placeholderIcon={<Pencil size={20}/>} /> : <img src={item.imageUrl} className="w-full h-full object-cover" />}
                                </div>
                            )}
                         </div>
                         {item.options && (
                             <div className="flex overflow-x-auto gap-4 pb-2 -mx-2 px-2 snap-x no-scrollbar mt-2">
                                {item.options.map((opt, idx) => (
                                    <div key={idx} className="min-w-[85%] snap-center bg-white/85 backdrop-blur-md rounded-[24px] p-4 shadow-card border border-white/40 flex gap-3">
                                        <div className="flex-1"><h3 className="text-base font-serif font-bold text-sabah-dark mb-1">{opt.activity}</h3><span className="text-[10px] text-gray-500">{opt.location}</span></div>
                                        <div className="w-16 h-16 rounded-xl bg-gray-100 overflow-hidden flex-shrink-0"><img src={opt.imageUrl} className="w-full h-full object-cover"/></div>
                                    </div>
                                ))}
                             </div>
                         )}
                         {(editingId === item.id || item.notes) && (
                            <div className={`mt-2 p-3 rounded-xl border ${editingId === item.id ? 'bg-white border-sabah-blue/50' : 'bg-white/50 border-gray-100/50'}`}>
                                {editingId === item.id ? (
                                    <textarea value={item.notes || ''} onChange={(e) => handleSaveNote(item.id, e.target.value)} className="w-full text-xs bg-transparent outline-none h-16" placeholder="Ëº∏ÂÖ•ÂÇôË®ª..." />
                                ) : <p className="text-xs text-gray-500">üí° {item.notes}</p>}
                            </div>
                         )}
                      </div>
                   </div>
                   {item.travelTime && index < dayPlan.items.length - 1 && <div className="flex items-center gap-2 ml-[18px] h-10 border-l-[2px] border-dashed border-gray-300 pl-4 relative my-1"><div className="absolute left-[-5px] top-1/2 -translate-y-1/2 w-2 h-2 rounded-full bg-gray-300"></div><div className="flex items-center gap-1.5 bg-white/70 backdrop-blur px-2 py-1 rounded-full border border-gray-100 shadow-sm"><ArrowDown size={10} className="text-gray-400" /><span className="text-[10px] font-bold text-gray-500">{item.travelTime}</span></div></div>}
                </div>
              ))}
            </div>
          </div>
        );
      };

      // --- MapComponent (Pure Leaflet to avoid React-Leaflet Context issues) ---
      const MapComponent = ({ dayPlans, selectedDate }) => {
        const mapRef = useRef(null);
        const mapInstance = useRef(null);
        const markersRef = useRef([]);

        const activePlan = dayPlans.find(d => d.date === selectedDate);
        
        // Custom Icons
        const createIcon = (color, isUser) => L.divIcon({
            className: 'custom-pin',
            html: `<div style="background-color:${color};width:${isUser?18:16}px;height:${isUser?18:16}px;border:${isUser?3:3}px solid white;border-radius:50%;box-shadow:0 2px 4px rgba(0,0,0,0.3);"></div>`,
            iconSize: [16, 16]
        });

        const houseIcon = L.divIcon({
            className: 'custom-house-icon',
            html: `<div style="background-color:#F26B3A;width:32px;height:32px;border-radius:50%;border:2px solid white;box-shadow:0 2px 5px rgba(0,0,0,0.2);display:flex;align-items:center;justify-content:center;color:white;"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg></div>`,
            iconSize: [32, 32],
            iconAnchor: [16, 32],
            popupAnchor: [0, -34]
        });

        useEffect(() => {
            if (!mapInstance.current && mapRef.current) {
                mapInstance.current = L.map(mapRef.current, { zoomControl: false }).setView([5.9904, 116.0798], 13);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: 'OSM' }).addTo(mapInstance.current);
            }
            
            // Clear existing markers
            markersRef.current.forEach(m => m.remove());
            markersRef.current = [];

            if (!activePlan || !mapInstance.current) return;

            const bounds = L.latLngBounds([]);

            // Add Accommodation
            const accMarker = L.marker([5.9904, 116.0798], { icon: houseIcon }).addTo(mapInstance.current).bindPopup('<b>‰ΩèÂÆø: Jesselton Quay</b>');
            markersRef.current.push(accMarker);
            bounds.extend([5.9904, 116.0798]);

            // Add Items
            activePlan.items.forEach(item => {
                const addM = (lat, lng, title) => {
                    const m = L.marker([lat, lng], { icon: createIcon('#F26B3A', false) }).addTo(mapInstance.current).bindPopup(`<b>${title}</b>`);
                    markersRef.current.push(m);
                    bounds.extend([lat, lng]);
                };
                if (item.coords) addM(item.coords.lat, item.coords.lng, item.activity);
                if (item.options) item.options.forEach(opt => addM(opt.coords.lat, opt.coords.lng, opt.activity));
            });

            if (markersRef.current.length > 0) {
                mapInstance.current.fitBounds(bounds, { padding: [50, 50] });
            }

            // Cleanup on unmount or date change not needed for map instance, but marker clearing is handled
        }, [activePlan]);

        return (
            <div className="w-full h-full relative z-0">
                <div ref={mapRef} className="w-full h-full" />
                <div className="absolute top-4 left-4 right-4 z-[400] pointer-events-none">
                    <div className="bg-white/90 backdrop-blur-md p-4 rounded-[20px] shadow-soft border border-white/50 flex justify-between items-center">
                        <div><h3 className="font-bold text-sabah-dark text-sm font-serif">‰ªäÊó•Âú∞Âúñ</h3><p className="text-[10px] text-gray-500 font-bold uppercase tracking-wider">{markersRef.current.length} ÂÄãÂú∞Èªû</p></div>
                        <div className="bg-sabah-blue/10 p-2 rounded-full text-sabah-blue"><MapIcon size={20} /></div>
                    </div>
                </div>
            </div>
        );
      };

      // --- ExpenseTracker ---
      const ExpenseTracker = ({ expenses, onAddExpense, onDeleteExpense }) => {
        const [amount, setAmount] = useState('');
        const [desc, setDesc] = useState('');
        const [cat, setCat] = useState('food');
        const [payer, setPayer] = useState('JIA');
        const [method, setMethod] = useState('cash');
        const [isSplit, setIsSplit] = useState(false);
        const [filter, setFilter] = useState(null);

        const filtered = filter ? expenses.filter(e => e.payer === filter) : expenses;
        const totalTWD = filtered.reduce((s, e) => s + e.amountTWD, 0);
        const totalMYR = filtered.reduce((s, e) => s + e.amountMYR, 0);

        const splitData = useMemo(() => {
            const splits = expenses.filter(e => e.isSplit);
            const total = splits.reduce((s, e) => s + e.amountTWD, 0);
            const jiaPaid = splits.filter(e => e.payer === 'JIA').reduce((s, e) => s + e.amountTWD, 0);
            const diff = jiaPaid - (total / 2);
            return { debtor: diff > 0 ? 'KIA' : 'JIA', creditor: diff > 0 ? 'JIA' : 'KIA', amount: Math.abs(diff) };
        }, [expenses]);

        const handleSubmit = (e) => {
            e.preventDefault();
            const val = parseFloat(amount);
            if (!val || !desc) return;
            onAddExpense({ id: Date.now().toString(), amountMYR: val, amountTWD: val * EXCHANGE_RATE, category: cat, description: desc, date: new Date().toISOString().split('T')[0], time: new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit',hour12:false}), payer, paymentMethod: method, isSplit });
            setAmount(''); setDesc('');
        };

        return (
            <div className="flex flex-col h-full font-sans">
                <div className="sticky top-0 z-30 bg-sabah-bg/95 backdrop-blur-xl pt-safe px-6 pb-4 border-b border-gray-100/50 shadow-sm">
                   <div className="flex overflow-x-auto gap-4 pb-1 -mx-2 px-2 snap-x no-scrollbar pt-2">
                       <div className="min-w-[100%] snap-center bg-sabah-dark rounded-[32px] p-6 text-white shadow-xl relative overflow-hidden">
                           <div className="flex justify-between items-start mb-2"><h2 className="text-gray-400 text-xs font-bold uppercase tracking-widest">Á∏ΩÊîØÂá∫</h2><div className="flex gap-1"><button onClick={()=>setFilter(null)} className={`px-2 py-0.5 rounded text-[10px] border ${!filter?'bg-white text-sabah-dark':'border-gray-600'}`}>ALL</button><button onClick={()=>setFilter('JIA')} className={`px-2 py-0.5 rounded text-[10px] border ${filter==='JIA'?'bg-sabah-blue border-sabah-blue':'border-gray-600'}`}>JIA</button><button onClick={()=>setFilter('KIA')} className={`px-2 py-0.5 rounded text-[10px] border ${filter==='KIA'?'bg-sabah-orange border-sabah-orange':'border-gray-600'}`}>KIA</button></div></div>
                           <span className="text-4xl font-sans font-bold tracking-tight">NT$ {totalTWD.toLocaleString(undefined,{maximumFractionDigits:0})}</span>
                           <div className="mt-4 text-xs text-gray-400">MYR {totalMYR.toLocaleString()}</div>
                       </div>
                       <div className="min-w-[100%] snap-center bg-white rounded-[32px] p-6 text-sabah-dark shadow-xl border border-gray-100 flex flex-col justify-center">
                           <div className="flex justify-between items-center mb-4"><h2 className="text-gray-400 text-xs font-bold uppercase tracking-widest">ÂàÜÂ∏≥ÁµêÁÆó</h2><Users size={18} className="text-sabah-green"/></div>
                           {splitData.amount < 1 ? <div className="text-center font-bold text-gray-400">ÁõÆÂâçÁµêÊ∏Ö</div> : 
                             <div className="flex items-center justify-between px-2">
                                <div className="text-center"><div className={`w-10 h-10 rounded-full flex items-center justify-center font-bold text-white mb-1 ${splitData.debtor==='JIA'?'bg-sabah-blue':'bg-sabah-orange'}`}>{splitData.debtor}</div><span className="text-[10px] text-gray-400">ÊîØ‰ªò</span></div>
                                <div className="font-mono font-bold text-xl">NT$ {splitData.amount.toFixed(0)}</div>
                                <div className="text-center"><div className={`w-10 h-10 rounded-full flex items-center justify-center font-bold text-white mb-1 ${splitData.creditor==='JIA'?'bg-sabah-blue':'bg-sabah-orange'}`}>{splitData.creditor}</div><span className="text-[10px] text-gray-400">Êî∂Ê¨æ</span></div>
                             </div>}
                       </div>
                   </div>
                </div>
                <div className="flex-1 px-6 pb-24 pt-4">
                    <form onSubmit={handleSubmit} className="bg-white rounded-[24px] p-5 shadow-card mb-8">
                       <h3 className="text-sabah-dark font-serif font-bold text-lg mb-4">Êñ∞Â¢ûÁ¥ÄÈåÑ</h3>
                       <div className="bg-sabah-bg rounded-2xl p-4 mb-4 flex items-center gap-4">
                           <div className="flex-1"><span className="text-sabah-dark font-bold mr-1">RM</span><input type="number" value={amount} onChange={e=>setAmount(e.target.value)} placeholder="0" className="bg-transparent text-2xl font-bold w-20 outline-none"/></div>
                           <div className="text-right"><span className="text-[10px] text-gray-400">Á¥Ñ NT$</span> <span className="text-xl font-bold text-sabah-blue">{amount ? (parseFloat(amount)*EXCHANGE_RATE).toFixed(0) : '0'}</span></div>
                       </div>
                       <input type="text" value={desc} onChange={e=>setDesc(e.target.value)} placeholder="È†ÖÁõÆË™™Êòé" className="w-full bg-white border-b-2 border-gray-100 p-3 text-sm mb-4 outline-none"/>
                       <div className="grid grid-cols-5 gap-1 mb-4">{['food','transport','shopping','stay','other'].map(c=><button key={c} type="button" onClick={()=>setCat(c)} className={`py-2 rounded-xl text-[10px] font-bold border ${cat===c?'bg-sabah-dark text-white':'bg-white text-gray-400'}`}>{c}</button>)}</div>
                       <div className="flex gap-3 mb-6">
                           <div className="flex bg-sabah-bg rounded-xl p-1"><button type="button" onClick={()=>setPayer('JIA')} className={`px-3 py-2 rounded-lg text-xs font-bold ${payer==='JIA'?'bg-sabah-blue text-white':'text-gray-400'}`}>JIA</button><button type="button" onClick={()=>setPayer('KIA')} className={`px-3 py-2 rounded-lg text-xs font-bold ${payer==='KIA'?'bg-sabah-orange text-white':'text-gray-400'}`}>KIA</button></div>
                           <button type="button" onClick={()=>setIsSplit(!isSplit)} className={`flex-1 rounded-xl flex items-center justify-center gap-2 text-xs font-bold border ${isSplit?'bg-sabah-green/10 text-sabah-green border-sabah-green':'text-gray-400 border-gray-200'}`}><Users size={14}/> ÂàÜÂ∏≥</button>
                       </div>
                       <button type="submit" className="w-full bg-sabah-yellow text-sabah-dark font-bold py-4 rounded-xl shadow-lg flex items-center justify-center gap-2"><Plus size={18}/> Âä†ÂÖ•Èå¢ÂåÖ</button>
                    </form>
                    <div className="space-y-3">
                        {[...filtered].reverse().map(e => (
                             <div key={e.id} className="bg-white p-4 rounded-2xl shadow-card flex items-center justify-between group relative">
                                 <button onClick={()=>onDeleteExpense(e.id)} className="absolute right-4 top-4 text-red-400 opacity-0 group-hover:opacity-100"><Trash2 size={16}/></button>
                                 <div className="flex items-center gap-3">
                                     <div className={`w-10 h-10 rounded-xl flex items-center justify-center bg-gray-50 text-gray-500`}><Coffee size={18}/></div>
                                     <div><p className="font-serif font-bold text-sabah-dark text-sm">{e.description}</p><div className="flex gap-2 text-[10px] text-gray-400 font-bold uppercase mt-0.5"><span className={e.payer==='JIA'?'text-sabah-blue':'text-sabah-orange'}>{e.payer}</span><span>{e.date.slice(5)}</span></div></div>
                                 </div>
                                 <div className="text-right"><p className="font-bold text-sabah-dark">RM {e.amountMYR}</p><p className="text-xs text-gray-400">NT$ {e.amountTWD.toFixed(0)}</p></div>
                             </div>
                        ))}
                    </div>
                </div>
            </div>
        );
      };

      // --- ShoppingList ---
      const ShoppingList = () => {
        const [locs, setLocs] = useState(INITIAL_SHOPPING_LOCATIONS);
        const [items, setItems] = useState(INITIAL_SHOPPING_ITEMS);
        const [expanded, setExpanded] = useState(false);
        const [selItem, setSelItem] = useState(null);

        return (
           <div className="px-6 pt-safe pb-32 animate-fade-in relative">
               <h2 className="text-3xl font-serif font-bold text-sabah-dark mb-6 mt-6">Ë≥ºÁâ©Ê∏ÖÂñÆ</h2>
               <div className="bg-red-50/90 border border-red-100 rounded-[20px] p-5 mb-8 shadow-sm">
                   <div className="flex items-center gap-2 mb-3 text-red-600"><AlertTriangle size={20}/><h3 className="font-bold text-sm">ÂÖ•Â¢ÉÊ≥®ÊÑè‰∫ãÈ†Ö</h3></div>
                   <div className="text-[10px] text-gray-600 space-y-1"><p>‚ùå ËÇâÈ°ûË£ΩÂìÅ (Âê´Ê≥°È∫µ)</p><p>‚ùå Êñ∞ÈÆÆÊ∞¥Êûú (Ê¶¥Êß§)</p></div>
               </div>
               <div className="mb-10">
                   <div onClick={()=>setExpanded(!expanded)} className="flex justify-between items-center mb-4 cursor-pointer"><h3 className="text-lg font-serif font-bold text-sabah-dark flex gap-2"><MapPin size={18} className="text-sabah-blue"/>Ë≥ºÁâ©Âú∞Èªû</h3>{expanded?<ChevronUp size={16}/>:<ChevronDown size={16}/>}</div>
                   {expanded && <div className="flex flex-col gap-3 animate-fade-in">{locs.map(l=><div key={l.id} className="bg-white/90 rounded-2xl p-4 border border-white/50 flex gap-4"><div className="flex-1"><h4 className="font-bold text-sabah-dark">{l.name}</h4><p className="text-xs text-gray-500">{l.description}</p></div><div className="w-16 h-16 bg-gray-100 rounded-xl overflow-hidden"><img src={l.imageUrl} className="w-full h-full object-cover"/></div></div>)}</div>}
               </div>
               <div className="grid grid-cols-2 gap-4">
                   {items.map(i=>(
                       <div key={i.id} onClick={()=>setSelItem(i)} className="bg-white/90 rounded-2xl p-3 shadow-card border border-white/50 cursor-pointer">
                           <div className="aspect-square bg-gray-100 rounded-xl mb-3 overflow-hidden"><img src={i.imageUrl} className="w-full h-full object-cover"/></div>
                           <h4 className="font-bold text-sabah-dark text-xs mb-1 line-clamp-1">{i.name}</h4>
                           <p className="text-[10px] text-gray-500 line-clamp-2">{i.description}</p>
                       </div>
                   ))}
               </div>
               <button className="fixed bottom-24 right-6 w-14 h-14 bg-sabah-blue text-white rounded-full shadow-lg flex items-center justify-center z-40"><Plus size={28}/></button>
               {selItem && (
                   <div className="fixed inset-0 z-[60] flex items-center justify-center p-4">
                       <div className="absolute inset-0 bg-black/40 backdrop-blur-sm" onClick={()=>setSelItem(null)}></div>
                       <div className="bg-white rounded-[32px] p-6 w-full max-w-sm relative z-10 animate-[fadeIn_0.3s_ease-out]">
                           <button onClick={()=>setSelItem(null)} className="absolute top-4 right-4"><X size={20} className="text-gray-500"/></button>
                           <div className="aspect-[4/3] rounded-2xl bg-gray-100 overflow-hidden mb-5"><img src={selItem.imageUrl} className="w-full h-full object-cover"/></div>
                           <h2 className="text-2xl font-serif font-bold text-sabah-dark mb-2">{selItem.name}</h2>
                           <p className="text-sm text-gray-600 leading-relaxed">{selItem.description}</p>
                       </div>
                   </div>
               )}
           </div>
        );
      };

      // --- InfoPage ---
      const InfoPage = () => {
         const [checklist, setChecklist] = useState([
             {id:1, text:"Ë≠∑ÁÖß > 6ÂÄãÊúà", checked:false}, {id:2, text:"MDAC ÂÖ•Â¢ÉÂç°", checked:false}, {id:3, text:"Ëê¨Áî®ËΩâÊé•È†≠", checked:false}, {id:4, text:"Grab App", checked:false}
         ]);
         const [txt, setTxt] = useState("");
         return (
             <div className="px-6 pt-safe pb-24 animate-fade-in space-y-4">
                 <h2 className="text-3xl font-serif font-bold text-sabah-dark mb-6 mt-6">ÊóÖÈÅäË≥áË®ä</h2>
                 <div className="bg-white/90 p-5 rounded-[24px] shadow-card"><div className="flex gap-3 mb-3"><FileText className="text-sabah-blue"/><h3 className="font-bold">ÂÖ•Â¢É & Á∞ΩË≠â</h3></div><p className="text-sm text-gray-600">MDAC ÂøÖÂ°´„ÄÇË≠∑ÁÖßÊïàÊúü > 6ÂÄãÊúà„ÄÇ</p></div>
                 <div className="bg-white/90 p-5 rounded-[24px] shadow-card"><div className="flex gap-3 mb-3"><Plug className="text-blue-500"/><h3 className="font-bold">ÈõªÂ£ì & ÊèíÂ∫ß</h3></div><p className="text-sm text-gray-600">Ëã±Ë¶è‰∏âÂ≠î (Type G)„ÄÇ220V„ÄÇ</p></div>
                 <div className="bg-sabah-dark text-white p-5 rounded-[24px]">
                     <h3 className="font-bold mb-4 flex gap-2"><Check className="text-sabah-green"/> Âá∫ÁôºÊ™¢Êü•</h3>
                     <div className="space-y-2 mb-4">
                         {checklist.map(i=>(
                             <div key={i.id} onClick={()=>setChecklist(p=>p.map(x=>x.id===i.id?{...x,checked:!x.checked}:x))} className="flex items-center gap-3 p-3 bg-white rounded-xl border border-gray-100 cursor-pointer">
                                 <div className={`w-5 h-5 rounded border flex items-center justify-center ${i.checked?'bg-sabah-green border-sabah-green':'border-gray-300'}`}>{i.checked&&<Check size={14} className="text-white"/>}</div>
                                 <span className={`text-sm text-sabah-dark ${i.checked?'line-through opacity-50':''}`}>{i.text}</span>
                             </div>
                         ))}
                     </div>
                     <div className="flex gap-2"><input value={txt} onChange={e=>setTxt(e.target.value)} placeholder="Êñ∞Â¢û..." className="flex-1 bg-white/10 rounded-xl px-4 py-3 text-sm text-white"/><button onClick={()=>{if(txt)setChecklist(p=>[...p,{id:Date.now(),text:txt,checked:false}]);setTxt('')}} className="bg-sabah-blue p-3 rounded-xl"><Plus/></button></div>
                 </div>
             </div>
         );
      };

      // --- App Root ---
      const NavItem = ({ icon, label, isActive, onClick }) => (
        <button onClick={onClick} className={`flex flex-col items-center gap-1 w-full ${isActive?'text-sabah-blue':'text-gray-400'}`}>
           <div className={`p-1.5 rounded-2xl transition-all ${isActive?'bg-blue-50/80 scale-110 -translate-y-1':'bg-transparent'}`}>{React.cloneElement(icon, {size:24, strokeWidth:isActive?2.5:2})}</div>
           <span className="text-[10px] font-bold">{label}</span>
        </button>
      );

      const App = () => {
        const [showSplash, setShowSplash] = useState(true);
        const [activeTab, setActiveTab] = useState('plan');
        const [dayPlans, setDayPlans] = useState(INITIAL_ITINERARY);
        const [expenses, setExpenses] = useState([]);
        const [selectedDate, setSelectedDate] = useState(INITIAL_ITINERARY[0].date);
        const currentDayPlan = dayPlans.find(d => d.date === selectedDate) || dayPlans[0];

        const handleUpdateDay = (updated) => setDayPlans(prev => prev.map(d => d.date === updated.date ? updated : d));

        return (
          <HashRouter>
            {showSplash && (
               <div onClick={()=>setShowSplash(false)} className="fixed inset-0 z-[100] cursor-pointer bg-black flex items-center justify-center">
                  <img src="https://i.pinimg.com/736x/a1/68/29/a168297e14852587d40f2ac06dd2a1e5.jpg" className="absolute inset-0 w-full h-full object-cover opacity-90"/>
                  <div className="relative z-10 text-white text-center"><h1 className="text-6xl font-serif font-black tracking-wider drop-shadow-2xl">SABAH</h1><p className="text-xs font-sans mt-8 opacity-70 animate-pulse">ÈªûÊìäÈñãÂßã</p></div>
               </div>
            )}
            <div className="flex justify-center min-h-dvh bg-gray-900 font-sans text-sabah-dark">
              <div className="w-full max-w-[480px] h-dvh relative shadow-2xl overflow-hidden flex flex-col bg-sabah-bg">
                 <div className="absolute inset-0 z-0">
                    {activeTab === 'plan' && <img src={currentDayPlan.bgImage} className="w-full h-full object-cover transition-opacity duration-700"/>}
                    <div className="absolute inset-0 bg-white/30 backdrop-blur-[1px]"></div>
                 </div>
                 
                 {activeTab === 'plan' && (
                    <div className="relative z-20 bg-white/30 backdrop-blur-md shadow-sm border-b border-white/20 pb-2">
                       <div className="pt-safe pb-1 text-center mb-2"><h2 className="text-2xl font-serif font-bold text-sabah-dark mt-3">Sabah | ‰∫ûÂ∫áÊµ∑‰∏≠ÈÅä</h2></div>
                       <div className="flex items-center justify-between px-2">
                           <div className="flex-1 overflow-hidden"><DateSelector days={dayPlans} selectedDate={selectedDate} onSelectDate={setSelectedDate} /></div>
                           <div className="flex flex-col items-end pl-2 pr-4 gap-1 min-w-[80px]">
                               <span className="bg-sabah-blue/90 text-white px-2 py-0.5 rounded-full text-[10px] font-bold">MALAYSIA</span>
                               <div className="flex items-center gap-1.5 bg-white/90 px-2 py-1 rounded-lg"><Sun size={14} className="text-sabah-yellow"/><div className="flex flex-col items-end leading-none"><span className="text-xs font-bold text-sabah-dark">{currentDayPlan.weatherTemp}¬∞C</span><span className="text-[8px] text-gray-400">{currentDayPlan.weatherCondition}</span></div></div>
                           </div>
                       </div>
                    </div>
                 )}

                 <main className={`flex-1 overflow-y-auto no-scrollbar relative z-10 ${activeTab==='map'?'h-full':''}`}>
                    {activeTab === 'plan' && <ItineraryList dayPlan={currentDayPlan} onUpdate={handleUpdateDay} />}
                    {activeTab === 'map' && <MapComponent dayPlans={dayPlans} selectedDate={selectedDate} />}
                    {activeTab === 'wallet' && <ExpenseTracker expenses={expenses} onAddExpense={e=>setExpenses(p=>[...p,e])} onDeleteExpense={id=>setExpenses(p=>p.filter(x=>x.id!==id))} />}
                    {activeTab === 'shopping' && <ShoppingList />}
                    {activeTab === 'info' && <InfoPage />}
                 </main>

                 <nav className="relative z-50 bg-white/95 backdrop-blur-xl border-t border-gray-100 pb-safe shadow-[0_-10px_40px_rgba(0,0,0,0.05)]">
                    <div className="flex justify-between items-center px-4 py-2">
                       <NavItem icon={<Calendar/>} label="Ë°åÁ®ã" isActive={activeTab==='plan'} onClick={()=>setActiveTab('plan')}/>
                       <NavItem icon={<MapIcon/>} label="Âú∞Âúñ" isActive={activeTab==='map'} onClick={()=>setActiveTab('map')}/>
                       <NavItem icon={<Wallet/>} label="Ë®òÂ∏≥" isActive={activeTab==='wallet'} onClick={()=>setActiveTab('wallet')}/>
                       <NavItem icon={<ShoppingBag/>} label="Ë≥ºÁâ©" isActive={activeTab==='shopping'} onClick={()=>setActiveTab('shopping')}/>
                       <NavItem icon={<Info/>} label="Ë≥áË®ä" isActive={activeTab==='info'} onClick={()=>setActiveTab('info')}/>
                    </div>
                 </nav>
              </div>
            </div>
          </HashRouter>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
</body>
</html>