<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Sabah Travel Companion</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Noto+Serif+TC:wght@500;700;900&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #1a202c; /* gray-900 */
            overscroll-behavior-y: none;
            -webkit-tap-highlight-color: transparent;
        }
        .font-serif-tc { font-family: 'Noto Serif TC', serif; }
        .font-sans-tc { font-family: 'Noto Sans TC', sans-serif; }
        
        /* Hide scrollbar */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .pt-safe { padding-top: env(safe-area-inset-top, 20px); }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom, 20px); }

        /* Custom Leaflet Icons via CSS/JS injection */
        .custom-user-location {
            background-color: #0077BE; width: 18px; height: 18px; border-radius: 50%;
            border: 3px solid white; box-shadow: 0 0 15px rgba(0, 119, 190, 0.5);
        }
        .custom-house-icon {
            background-color: #F26B3A; width: 32px; height: 32px; border-radius: 50%;
            border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            display: flex; align-items: center; justify-content: center; color: white;
        }
        
        /* Accordion transition */
        .accordion-content { transition: max-height 0.3s ease-out, opacity 0.3s ease-out; max-height: 0; opacity: 0; overflow: hidden; }
        .accordion-content.open { max-height: 500px; opacity: 1; }
    </style>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        sabah: {
                            bg: '#F9F9F7',
                            yellow: '#F3C969',
                            orange: '#F26B3A',
                            blue: '#0077BE',
                            lightblue: '#89CFF0',
                            green: '#508A75',
                            dark: '#2D3436',
                            gray: '#A0A0A0'
                        }
                    },
                    fontFamily: {
                        serif: ['"Noto Serif TC"', 'serif'],
                        sans: ['"Noto Sans TC"', 'sans-serif'],
                    },
                    boxShadow: {
                        'soft': '0 10px 40px -10px rgba(0,0,0,0.08)',
                        'card': '0 4px 20px -2px rgba(0,0,0,0.05)'
                    }
                }
            }
        }
    </script>
<script type="importmap">
{
  "imports": {
    "react/": "https://aistudiocdn.com/react@^19.2.1/",
    "react": "https://aistudiocdn.com/react@^19.2.1",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.1/",
    "react-router-dom": "https://aistudiocdn.com/react-router-dom@^7.10.1",
    "lucide-react": "https://aistudiocdn.com/lucide-react@^0.556.0",
    "leaflet": "https://aistudiocdn.com/leaflet@^1.9.4",
    "react-leaflet": "https://aistudiocdn.com/react-leaflet@^5.0.0"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
<body>

    <!-- App Container -->
    <div class="flex justify-center min-h-[100dvh] font-sans text-sabah-dark">
        <div class="w-full max-w-[480px] h-[100dvh] relative shadow-2xl overflow-hidden flex flex-col bg-sabah-bg" id="app-root">
            
            <!-- Dynamic Background -->
            <div id="bg-layer" class="absolute inset-0 z-0">
                <!-- Injected via JS -->
            </div>

            <!-- Header -->
            <div id="header-container" class="relative z-20 transition-all duration-300">
                <!-- Injected via JS -->
            </div>

            <!-- Main Content -->
            <main id="main-content" class="flex-1 overflow-y-auto no-scrollbar relative z-10 w-full">
                <!-- Injected via JS -->
            </main>

            <!-- Bottom Navigation -->
            <nav class="relative z-50 bg-white/95 backdrop-blur-xl border-t border-gray-100 pb-safe shadow-[0_-10px_40px_rgba(0,0,0,0.05)]">
                <div class="flex justify-between items-center px-4 py-2" id="nav-container">
                    <!-- Injected via JS -->
                </div>
            </nav>

            <!-- Splash Screen -->
            <div id="splash-screen" class="fixed inset-0 z-[100] cursor-pointer bg-black flex flex-col items-center justify-center text-white text-center p-8 transition-opacity duration-500" onclick="App.dismissSplash()">
                <img src="https://i.pinimg.com/736x/a1/68/29/a168297e14852587d40f2ac06dd2a1e5.jpg" alt="Splash" class="absolute inset-0 w-full h-full object-cover opacity-90">
                <div class="absolute inset-0 bg-black/20 backdrop-blur-[2px]"></div>
                <div class="relative z-10 space-y-4 animate-fade-in">
                    <p class="text-xl font-sans tracking-[0.3em] font-light uppercase opacity-90">Welcome to</p>
                    <h1 class="text-6xl font-serif font-black tracking-wider drop-shadow-2xl">SABAH</h1>
                    <div class="w-12 h-1 bg-white/80 mx-auto rounded-full mt-6"></div>
                    <p class="text-xs font-sans mt-8 opacity-70 animate-pulse">ÈªûÊìä‰ªªÊÑèËôïÈñãÂßã</p>
                </div>
            </div>

            <!-- Modals -->
            <div id="modal-container" class="fixed inset-0 z-[60] hidden pointer-events-none">
                <div class="absolute inset-0 bg-black/40 backdrop-blur-sm pointer-events-auto transition-opacity" onclick="App.closeModal()"></div>
                <div id="modal-content" class="absolute bg-white rounded-[32px] p-6 w-full max-w-sm left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 pointer-events-auto shadow-2xl transition-all scale-95 opacity-0">
                    <!-- Dynamic Content -->
                </div>
            </div>
            
            <!-- Note Editor Modal specific -->
             <div id="note-modal" class="hidden fixed inset-0 z-[70] flex items-center justify-center p-6 bg-black/50 backdrop-blur-sm">
                <div class="bg-white w-full max-w-sm rounded-2xl p-4 shadow-xl">
                    <h3 class="font-bold text-lg mb-2 text-sabah-dark">Á∑®ËºØÂÇôË®ª</h3>
                    <textarea id="note-input" class="w-full h-24 p-3 border border-gray-200 rounded-xl resize-none text-sm outline-none focus:border-sabah-blue mb-4" placeholder="Ëº∏ÂÖ•ÂÖßÂÆπ..."></textarea>
                    <div class="flex justify-end gap-2">
                        <button onclick="App.closeNoteModal()" class="px-4 py-2 rounded-xl bg-gray-100 text-gray-500 font-bold text-xs">ÂèñÊ∂à</button>
                        <button onclick="App.saveNote()" class="px-4 py-2 rounded-xl bg-sabah-blue text-white font-bold text-xs">ÂÑ≤Â≠ò</button>
                    </div>
                </div>
            </div>

        </div>
    </div>

<script>
/**
 * DATA & CONSTANTS
 */
const LOCATIONS = {
  BKI_AIRPORT: { lat: 5.9375, lng: 116.0510, name: "Kota Kinabalu International Airport" },
  JESSELTON_QUAY: { lat: 5.9904, lng: 116.0798, name: "Jesselton Quay (JQ)" },
  BORENOS_CHICKEN: { lat: 5.9760, lng: 116.0738, name: "Borenos Fried Chicken (Asia City)" },
  FOOK_YUEN_GAYA: { lat: 5.9845, lng: 116.0775, name: "Fook Yuen (Gaya Street)" },
  YEE_FUNG_LAKSA: { lat: 5.9830, lng: 116.0770, name: "Yee Fung Laksa" },
  WISMA_MERDEKA: { lat: 5.9856, lng: 116.0777, name: "Wisma Merdeka" },
  JESSELTON_POINT: { lat: 5.9890, lng: 116.0780, name: "Jesselton Point Ferry Terminal" },
  MANUKAN_ISLAND: { lat: 5.9644, lng: 116.0076, name: "Manukan Island" },
  SAPI_ISLAND: { lat: 5.9606, lng: 116.0048, name: "Sapi Island" },
  YU_KEE_BAK_KUT_TEH: { lat: 5.9840, lng: 116.0772, name: "Yu Kee Bak Kut Teh" },
  SIN_KEE_BAK_KUT_TEH: { lat: 5.9825, lng: 116.0770, name: "Sin Kee Bak Kut Teh" },
  API_API_NIGHT_MARKET: { lat: 5.9835, lng: 116.0772, name: "Api-Api Night Market (Gaya St)" },
  WOO_CAFE: { lat: 5.9818, lng: 116.0785, name: "Woo!" },
  GUANS_KOPITIAM: { lat: 5.9835, lng: 116.0775, name: "Guan's Kopitiam" },
  UMS_MOSQUE: { lat: 6.0367, lng: 116.1186, name: "UMS Pink Mosque" },
  JIA_XIANG_LINTAS: { lat: 5.9490, lng: 116.0920, name: "Jia Xiang Sang Nyuk Mee (Lintas)" },
  IMAGO_MALL: { lat: 5.9705, lng: 116.0667, name: "Imago Shopping Mall" },
  TANJUNG_ARU_BEACH: { lat: 5.9482, lng: 116.0447, name: "Tanjung Aru Beach" },
  WELCOME_SEAFOOD: { lat: 5.9765, lng: 116.0740, name: "Welcome Seafood" },
  KAMA_SPA: { lat: 5.9815, lng: 116.0782, name: "Kama' A Rejuvenation & Wellbeing Spa" }
};

const INITIAL_ITINERARY = [
  {
    date: '2026-01-09', weatherTemp: 27, weatherCondition: 'Cloudy',
    bgImage: 'https://i.pinimg.com/736x/a4/ae/3f/a4ae3f8d0c49e9cbf2e725a42e6d24ba.jpg',
    flight: {
      departureTime: '19:15', departureCode: 'TPE', departureAirport: 'Âè∞ÁÅ£Ê°ÉÂúíÂúãÈöõÊ©üÂ†¥ ÔΩúT1Ëà™Âªà',
      arrivalTime: '22:50', arrivalCode: 'BKI', arrivalAirport: 'Âì•Êâì‰∫¨ÈÇ£Â∑¥È≠ØÂúãÈöõÊ©üÂ†¥ÔΩúT1Ëà™Âªà',
      airline: 'È¶¨‰æÜË•ø‰∫û‰∫ûÊ¥≤Ëà™Á©∫ÂÖ¨Âè∏ AK1511', flightNumber: 'AK1511', aircraft: 'Á∂ìÊøüËâô Á©∫‰∏≠Â∑¥Â£´ A320-212'
    },
    items: [
      { id: '1-1', time: '22:30', activity: 'ÊäµÈÅî‰∫ûÂ∫áÂúãÈöõÊ©üÂ†¥ (BKI)', location: 'Kota Kinabalu International Airport', coords: LOCATIONS.BKI_AIRPORT, type: 'transport' },
      { id: '1-2', time: '23:30', activity: 'ÊäµÈÅî‰ΩèÂÆø Jesselton Quay (JQ)', location: 'Jesselton Quay, Jalan Tun Fuad Stephens', coords: LOCATIONS.JESSELTON_QUAY, type: 'relax' },
      { id: '1-3', time: '23:50', activity: 'ÂÆµÂ§ú (‰∫åÈÅ∏‰∏Ä)', location: 'Swipe to view options', coords: LOCATIONS.BORENOS_CHICKEN, type: 'food', options: [
          { activity: 'Borenos Fried Chicken', location: 'Lot G23, Kompleks Asia City', coords: LOCATIONS.BORENOS_CHICKEN, notes: 'Âú®Âú∞Â•ΩÂêÉÁÇ∏ÈõûÔºåÈñãÂà∞ÂçäÂ§ú', imageUrl: 'https://images.unsplash.com/photo-1626082927389-6cd097cdc6ec?q=80&w=500&auto=format&fit=crop' },
          { activity: 'ÂØåÊ∫êËå∂È§êÂª≥ Fook Yuen', location: '53, Jalan Gaya', coords: LOCATIONS.FOOK_YUEN_GAYA, notes: 'ÂíñÊ§∞ÂêêÂè∏„ÄÅÊãâËå∂ÔºåÈñãÂà∞ÂæàÊôö', imageUrl: 'https://images.unsplash.com/photo-1589301760588-441b6f5e71a9?q=80&w=500&auto=format&fit=crop' }
      ]}
    ]
  },
  {
    date: '2026-01-10', weatherTemp: 31, weatherCondition: 'Sunny',
    bgImage: 'https://i.pinimg.com/1200x/39/b4/aa/39b4aa96ca7fe7de41f28623af1eaf8b.jpg',
    items: [
      { id: '2-1', time: '09:15', activity: 'Êó©È§êÔºöÊÄ°Ë±êËå∂ÂÆ§ Yee Fung Laksa', location: '127, Jalan Gaya', coords: LOCATIONS.YEE_FUNG_LAKSA, type: 'food', notes: 'ÂøÖÈªûÔºöÂèªÊ≤ô Laksa„ÄÅÊ≤ôÁÖ≤ÈõûÈ£Ø', imageUrl: 'https://images.unsplash.com/photo-1632204655513-3392e2124508?q=80&w=500&auto=format&fit=crop' },
      { id: '2-2', time: '10:00', activity: 'ÊèõÈå¢ÔºöWisma Merdeka', location: 'Wisma Merdeka, Jalan Tun Razak', coords: LOCATIONS.WISMA_MERDEKA, type: 'activity', notes: 'ÂåØÁéáÊúÄÂ•ΩÔºåÊèõÂÆåÁõ¥Êé•Ëµ∞ÂéªÊóÅÈÇäÁ¢ºÈ†≠' },
      { id: '2-3', time: '10:30', activity: 'Âá∫Êµ∑ÔºöJesselton Point Á¢ºÈ†≠', location: 'Jesselton Point Ferry Terminal', coords: LOCATIONS.JESSELTON_POINT, type: 'transport', notes: 'Ë≥ºÁ•®ÔºöTwo Islands - Sapi + Manukan' },
      { id: '2-4', time: '11:00', activity: 'ÈõôÂ≥∂ÊÖ¢ÈÅä (Manukan & Sapi)', location: 'Tunku Abdul Rahman Park', coords: LOCATIONS.MANUKAN_ISLAND, type: 'activity', notes: 'ÂêÑÁé©Á¥Ñ 2-2.5 Â∞èÊôÇÔºå‰∫´ÂèóÈôΩÂÖâÊ≤ôÁÅò' },
      { id: '2-5', time: '19:00', activity: 'ÊôöÈ§êÔºöËÇâÈ™®Ëå∂ (‰∫åÈÅ∏‰∏Ä)', location: 'Swipe to view options', coords: LOCATIONS.YU_KEE_BAK_KUT_TEH, type: 'food', options: [
           { activity: '‰ΩëË®òËÇâÈ™®Ëå∂ Yu Kee', location: '7, Jalan Gaya', coords: LOCATIONS.YU_KEE_BAK_KUT_TEH, notes: 'Ëó•ËÜ≥Âë≥ÈáçÔºåÁ¢óË£ù', imageUrl: 'https://images.unsplash.com/photo-1543363363-b8cf4b306b6f?q=80&w=500&auto=format&fit=crop' },
           { activity: 'Êñ∞Ë®òËÇâÈ™®Ëå∂ Sin Kee', location: '26, Jalan Pantai', coords: LOCATIONS.SIN_KEE_BAK_KUT_TEH, notes: 'ÊπØÈ†≠ÊøÉÈÉÅÔºåÁ†ÇÈçãË£ù', imageUrl: 'https://images.unsplash.com/photo-1627916508000-0df9a7978e5f?q=80&w=500&auto=format&fit=crop' }
      ]},
      { id: '2-6', time: '20:15', activity: 'ÈÄõË°óÔºöÂä†ÈõÖË°óÂ§úÂ∏Ç', location: 'Api-Api Night Market', coords: LOCATIONS.API_API_NIGHT_MARKET, type: 'activity', notes: 'ÈÄ±‰∫îÈÄ±ÂÖ≠ÈôêÂÆöÂ§úÂ∏Ç' }
    ]
  },
  {
    date: '2026-01-11', weatherTemp: 29, weatherCondition: 'Cloudy',
    bgImage: 'https://i.pinimg.com/1200x/fd/d5/18/fdd5185cbab77d2e1abf50b54b1fc656.jpg',
    items: [
      { id: '3-1', time: '10:45', activity: 'Á∂≤ÁæéÊó©ÂçàÈ§ê (‰∫åÈÅ∏‰∏Ä)', location: 'Swipe to view options', coords: LOCATIONS.WOO_CAFE, type: 'food', options: [
          { activity: 'Woo! Cafe', location: '25, Lorong Dewan', coords: LOCATIONS.WOO_CAFE, notes: 'Ê§çÁâ©Á≥ªÁ∂≤ÁæéÈ¢®ÔºåÁæ©Â§ßÂà©È∫µ„ÄÅÊó©ÂçàÈ§êÂ•ΩÂêÉ', imageUrl: 'https://images.unsplash.com/photo-1554118811-1e0d58224f24?q=80&w=500&auto=format&fit=crop' },
          { activity: 'Guan\'s Kopitiam', location: 'Jalan Gaya', coords: LOCATIONS.GUANS_KOPITIAM, notes: 'ÊúâÂÜ∑Ê∞£ÁöÑÂæ©Âè§È¢®ÔºåÊé®ÂíñÊ§∞ÂêêÂè∏„ÄÅÁ¥ÖÂíñÂì©Èõû', imageUrl: 'https://images.unsplash.com/photo-1559403842-70b925b4be46?q=80&w=500&auto=format&fit=crop' }
      ]},
      { id: '3-2', time: '13:30', activity: 'Èï∑ÈºªÁå¥ & Ëû¢ÁÅ´Ëü≤‰πãÊóÖ', location: 'Kawa Kawa / Weston (Pickup at JQ)', coords: LOCATIONS.JESSELTON_QUAY, type: 'activity', notes: 'ÊóÖË°åÁ§æÂ∞àËªäÊé•ÈÄÅÔºåË®òÂæóÂ∏∂Èò≤ËöäÊ∂≤' },
      { id: '3-3', time: '21:30', activity: 'ÂÆµÂ§ú (Ë¶ñÈ´îÂäõÊ±∫ÂÆö)', location: 'Jesselton Quay / ÂØåÊ∫ê', coords: LOCATIONS.FOOK_YUEN_GAYA, type: 'food' }
    ]
  },
  {
    date: '2026-01-12', weatherTemp: 32, weatherCondition: 'Sunny',
    bgImage: 'https://i.pinimg.com/1200x/3d/2b/b9/3d2bb9a9e3ebc71f0b73692f93e19633.jpg',
    items: [
      { id: '4-1', time: '11:00', activity: 'ÊôØÈªûÔºöÊ≤ôÂ∑¥Â§ßÂ≠∏Á≤âÁ¥ÖÊ∏ÖÁúüÂØ∫', location: 'Jalan UMS (UMS Pink Mosque)', coords: LOCATIONS.UMS_MOSQUE, type: 'activity', notes: 'Ë®òÂæóÁ©øËëóÂæóÈ´îÊàñÁßüÂÄüÈï∑Ë¢çÔºåÁ≤âÁ¥ÖÁâÜÈù¢Ë∂ÖÂ•ΩÊãç' },
      { id: '4-2', time: '12:30', activity: 'ÂçàÈ§êÔºöÂÆ∂È¶ôÁîüËÇâÈ∫µ', location: 'Lintas Plaza', coords: LOCATIONS.JIA_XIANG_LINTAS, type: 'food', notes: 'ÊπØÈ†≠ÈÆÆÁîúÔºåËÇâÁâáÊªëÂ´©', imageUrl: 'https://images.unsplash.com/photo-1626809804863-7c85172088f1?q=80&w=500&auto=format&fit=crop' },
      { id: '4-3', time: '14:00', activity: 'Ë≥ºÁâ©ÔºöImago Shopping Mall', location: 'KK Times Square', coords: LOCATIONS.IMAGO_MALL, type: 'activity', notes: 'Ë≤∑ Bata„ÄÅPadini„ÄÅË∂ÖÂ∏Ç‰º¥ÊâãÁ¶Æ (3Â∞èÊôÇ)' },
      { id: '4-4', time: '17:30', activity: 'Â§ïÈôΩÔºö‰∏πÁµ®‰∫ûË∑ØÊµ∑ÁÅò', location: 'Tanjung Aru Beach', coords: LOCATIONS.TANJUNG_ARU_BEACH, type: 'relax', notes: '‰∏ñÁïå‰∏âÂ§ßÂ§ïÈôΩ‰πã‰∏ÄÔºåÂÆö‰Ωç Beach 2 ÁÇ∫‰Ω≥' },
      { id: '4-5', time: '19:30', activity: 'ÊôöÈ§êÔºöÂ§ßËåÑ‰æÜÊµ∑ÈÆÆ', location: 'Kompleks Asia City', coords: LOCATIONS.WELCOME_SEAFOOD, type: 'food', notes: 'ÂøÖÈªûÔºöÊøïÂ•∂Ê≤πËÄÅËôéËù¶„ÄÅÈππËõãÈªÉÁÇíËüπ„ÄÅÊ°îÂ≠êÂÜ∞', imageUrl: 'https://images.unsplash.com/photo-1565557623262-b51c2513a641?q=80&w=500&auto=format&fit=crop' },
      { id: '4-6', time: '21:30', activity: 'ÊåâÊë©ÔºöKama‚Äô A Spa', location: '15, Jalan Dewan', coords: LOCATIONS.KAMA_SPA, type: 'relax', notes: 'ÊîæÈ¨ÜÂÆåÂõû JQ ÊâìÂåÖË°åÊùé' }
    ]
  },
  {
    date: '2026-01-13', weatherTemp: 26, weatherCondition: 'Rain',
    bgImage: 'https://i.pinimg.com/736x/7e/22/3f/7e223f12849b463bc9ce8caf19b59e53.jpg',
    flight: {
      departureTime: '07:40', departureCode: 'BKI', departureAirport: 'Âì•Êâì‰∫¨ÈÇ£Â∑¥È≠ØÂúãÈöõÊ©üÂ†¥ÔΩúT1Ëà™Âªà',
      arrivalTime: '10:55', arrivalCode: 'TPE', arrivalAirport: 'Âè∞ÁÅ£Ê°ÉÂúíÂúãÈöõÊ©üÂ†¥ÔΩúT1Ëà™Âªà',
      airline: 'È¶¨‰æÜË•ø‰∫û‰∫ûÊ¥≤Ëà™Á©∫ÂÖ¨Âè∏ AK1510', flightNumber: 'AK1510', aircraft: 'Á∂ìÊøüËâô Á©∫‰∏≠Â∑¥Â£´ A320-212'
    },
    items: [
      { id: '5-1', time: '04:45', activity: 'Ëµ∑Â∫ä & ÈÄÄÊàø', location: 'Jesselton Quay', coords: LOCATIONS.JESSELTON_QUAY, type: 'relax' },
      { id: '5-2', time: '05:00', activity: 'Âá∫ÁôºÂâçÂæÄ‰∫ûÂ∫áÊ©üÂ†¥', location: 'Kota Kinabalu International Airport', coords: LOCATIONS.BKI_AIRPORT, type: 'transport', notes: 'Âè´ GrabÔºå07:00 È£õÊ©üËµ∑È£õ ‚úàÔ∏è ÂõûÂÆ∂' }
    ]
  }
];

const SHOPPING_LOCATIONS = [
  { id: 'sl-1', name: 'Wisma Merdeka', description: 'ÊúÄ‰Ω≥ÊèõÂåØÂú∞ÈªûÔºå‰πüÊúâË≥£Á¥ÄÂøµÂìÅ', type: 'ÊèõÂåØ & Á¥ÄÂøµÂìÅ', googleMapQuery: 'Wisma Merdeka Kota Kinabalu', imageUrl: 'https://images.unsplash.com/photo-1574902998399-56d11bd85721?q=80&w=500' },
  { id: 'sl-2', name: 'Imago Shopping Mall', description: '‰∫ûÂ∫áÊúÄÂ§ßÂïÜÂ†¥ÔºåÂøÖË≤∑ Padini, Bata, Fipper, Eureka', type: 'Ë≥ºÁâ©‰∏≠ÂøÉ', googleMapQuery: 'Imago Shopping Mall Kota Kinabalu', imageUrl: 'https://images.unsplash.com/photo-1519567241046-7f570eee3d9f?q=80&w=500' },
  { id: 'sl-3', name: 'Gaya Street Market', description: 'ÈÄ±Êó•Â∏ÇÈõÜ / ÈÄ±‰∫îÂÖ≠Â§úÂ∏ÇÔºåÊâãÂ∑•ËóùÂìÅÂ§ö', type: 'Áï∂Âú∞Â∏ÇÈõÜ', googleMapQuery: 'Gaya Street Kota Kinabalu', imageUrl: 'https://images.unsplash.com/photo-1533900298318-6b8da08a523e?q=80&w=500' },
  { id: 'sl-4', name: 'Suria Sabah', description: '‰ΩçÊñºÊµ∑ÈÇäÁöÑË≥ºÁâ©‰∏≠ÂøÉÔºåÊúâÁÑ°ÊïµÊµ∑ÊôØÔºåË∂ÖÂ∏ÇÂ•ΩË≤∑', type: 'Ë≥ºÁâ©‰∏≠ÂøÉ', googleMapQuery: 'Suria Sabah Shopping Mall', imageUrl: 'https://images.unsplash.com/photo-1555529733-0e670560f7e1?q=80&w=500' },
  { id: 'sl-5', name: 'KK Plaza', description: 'Âú∞‰∏ãÂÆ§Ë∂ÖÂ∏Ç‰æøÂÆúÔºåÈÅ©ÂêàË≤∑‰º¥ÊâãÁ¶Æ', type: 'Ë∂ÖÂ∏Ç', googleMapQuery: 'KK Plaza Kota Kinabalu', imageUrl: 'https://images.unsplash.com/photo-1604719312566-b7e6012e6b17?q=80&w=500' }
];

const SHOPPING_ITEMS = [
  { id: 'si-1', name: 'Ê≤ôÂ∑¥Á¥ÖËå∂ (Sabah Tea)', description: 'Á•ûÂ±±ÊúâÊ©üÊ†ΩÁ®ÆÔºåÂë≥ÈÅìÂñÆÁ¥î‰∏çÊæÄ„ÄÇÊé®Ëñ¶Á∂†Ëâ≤ÂåÖË£ù„ÄÇ', rating: 5, imageUrl: 'https://images.unsplash.com/photo-1597481499750-3e6b22637e12?q=80&w=500', locationHint: 'ÂêÑÂ§ßË∂ÖÂ∏Ç' },
  { id: 'si-2', name: 'ÁõäÂíå‰∏πÂçóÂíñÂï°', description: 'Ê≤ôÂ∑¥ÊúÄÂè§ËÄÅÂíñÂï°ÔºåÂøÖË≤∑„ÄåÈäÄËâ≤ÂåÖË£ù Kopi O„ÄçÔºåÁÇ≠ÁáíÂë≥È¶ôÊøÉ„ÄÇ', rating: 4, imageUrl: 'https://images.unsplash.com/photo-1559496417-e7f25cb247f3?q=80&w=500', locationHint: 'Ë∂ÖÂ∏Ç' },
  { id: 'si-3', name: 'Beryl\'s Â∑ßÂÖãÂäõ', description: 'ÂúãÂØ∂Á¥öÂ∑ßÂÖãÂäõÔºåÊé®Ëñ¶ÊèêÊãâÁ±≥ËòáÂíåÊ¶¥Êß§Âè£Âë≥„ÄÇ', rating: 5, imageUrl: 'https://images.unsplash.com/photo-1511381978829-2c287a32d18b?q=80&w=500' },
  { id: 'si-4', name: 'Eureka ÁàÜÁ±≥Ëä±', description: 'È¶¨‰æÜË•ø‰∫ûÁî¢Âú∞ÂÉπÁ¥ÑÂè∞ÁÅ£6-7Êäò„ÄÇÂè£Âë≥Ë∂ÖÂ§ö(Áï™ËåÑ/ÈÖ∏Â•∂Ê¥ãËî•)„ÄÇ', rating: 5, locationHint: 'Imago Mall Â∞àÊ´É', imageUrl: 'https://images.unsplash.com/photo-1578849278619-e73505e9610f?q=80&w=500' },
  { id: 'si-5', name: 'A1 ËÇâÈ™®Ëå∂ÂåÖ', description: '‚ö†Ô∏è Âè™ËÉΩË≤∑Á¥îËó•ÊùêÁ≤â/È¶ôÊñôÂåÖÔºÅÂê´Ë±¨ËÇâÊàêÂàÜÁ¶ÅÂ∏∂ÂõûÂè∞(ÁΩ∞20Ëê¨)„ÄÇ', rating: 4, imageUrl: 'https://images.unsplash.com/photo-1596040033229-a9821ebd058d?q=80&w=500' },
  { id: 'si-6', name: 'Kaya ÂíñÊ§∞ÈÜ¨', description: 'Â¶ÇÊûúÊÑõ‰∏äÂØåÊ∫êÁöÑÂêêÂè∏ÔºåË≤∑ÁΩêÈ†≠Ë£ùÂõûÂÆ∂ÊäπÂêêÂè∏„ÄÇ', rating: 3, imageUrl: 'https://images.unsplash.com/photo-1589301760588-441b6f5e71a9?q=80&w=500' },
  { id: 'si-7', name: 'Fipper Â§æËÖ≥Êãñ', description: 'ÂúãÊ∞ëÊãñÈûã(Â§ßË±°Ê®ôË™å)„ÄÇÊ©°ËÜ†ÊùêË≥™Â•ΩÁ©øÈò≤ÊªëÔºåÈ°èËâ≤ÁπΩÁ¥õ„ÄÇ', rating: 5, priceEstimate: 'RM 20-40', locationHint: 'Imago Mall', imageUrl: 'https://images.unsplash.com/photo-1562124638-724e13052aaf?q=80&w=500' },
  { id: 'si-8', name: 'Padini (Vincci)', description: 'ÂúãÊ∞ëÂø´ÊôÇÂ∞ö„ÄÇVincci ÈûãÂåÖÈùûÂ∏∏‰æøÂÆúÂ•ΩÁúãÔºåÊ∂ºÈûãÂ∏∏‰∏çÂà∞Âè∞Âπ£400„ÄÇ', rating: 4, locationHint: 'Imago Mall', imageUrl: 'https://images.unsplash.com/photo-1543163521-1bf539c55dd2?q=80&w=500' },
  { id: 'si-9', name: 'Bata ÈûãÂ≠ê', description: 'Â∏Ç‰ΩîÁéáÈ´òÔºåÂÉπÊ†ºÊØîÂè∞ÁÅ£‰æøÂÆúÔºåÁ©øËµ∑‰æÜÂæàËªüÂæàËàíÊúç„ÄÇ', rating: 3, locationHint: 'Imago Mall', imageUrl: 'https://images.unsplash.com/photo-1595950653106-6c9ebd614d3a?q=80&w=500' },
  { id: 'si-10', name: 'Èï∑ÈºªÁå¥Â®ÉÂ®É', description: 'Â©ÜÁæÖÊ¥≤ÁâπÊúâÔºåÈºªÂ≠êÂ§ßÂ§ßÈÜúËêåÔºåÂæàÊúâÁ¥ÄÂøµÂÉπÂÄº„ÄÇ', rating: 4, imageUrl: 'https://images.unsplash.com/photo-1570414461014-429a4c58c1df?q=80&w=500' },
  { id: 'si-11', name: 'Ê≤ôÂ∑¥ÊâãÂ∑•ËóùÂìÅ', description: 'Á∑®ÁπîÂåÖ„ÄÅ‰∏≤Áè†ÔºåËâ≤ÂΩ©ÈÆÆË±î„ÄÇ', rating: 4, locationHint: 'Âä†ÈõÖË°óÂ∏ÇÈõÜ', imageUrl: 'https://images.unsplash.com/photo-1459416527563-3467614d9b62?q=80&w=500' },
  { id: 'si-12', name: 'The Art Attic ÊñáÂâµ', description: 'Áï∂Âú∞ËóùË°ìÂÆ∂Ë®≠Ë®àÁöÑÊòé‰ø°Áâá„ÄÅTÊÅ§„ÄÅÁ£ÅÈêµÔºåË≥™ÊÑüÂ•Ω„ÄÇ', rating: 4, imageUrl: 'https://images.unsplash.com/photo-1513519245088-0e12902e5a38?q=80&w=500' }
];

const EXCHANGE_RATE = 7.5;

/**
 * APPLICATION LOGIC (Controller)
 */
const App = {
    state: {
        tab: 'plan', // plan, map, wallet, shopping, info
        itinerary: INITIAL_ITINERARY,
        selectedDate: '2026-01-09',
        expenses: [],
        shopping: {
            locations: SHOPPING_LOCATIONS,
            items: SHOPPING_ITEMS,
            isLocationsExpanded: true
        },
        info: {
            checklist: [
                { id: 1, text: "Ë≠∑ÁÖß (ÊïàÊúü > 6ÂÄãÊúà)", checked: false },
                { id: 2, text: "ÂÆåÊàê MDAC ÈõªÂ≠êÂÖ•Â¢ÉÂç°Â°´ÂØ´", checked: false },
                { id: 3, text: "Ê©üÁ•®ÈõªÂ≠êÊ™îÂ≠òÊâãÊ©ü", checked: false },
                { id: 4, text: "Ëê¨Áî®ËΩâÊé•È†≠ (Ëã±Ë¶è‰∏âÂ≠î)", checked: false },
                { id: 5, text: "Grab App ‰∏ãËºâ‰∏¶Á∂ÅÂç°", checked: false },
                { id: 6, text: "Âè∞Âπ£ÁèæÈáë (Á¥Ñ NT$ 10,000 - 12,000)", checked: false },
                { id: 7, text: "ËÖ∏ËÉÉËó• / ÊöàËàπËó• / Èò≤ËöäÊ∂≤", checked: false },
            ]
        },
        wallet: {
            amount: '',
            desc: '',
            cat: 'food',
            payer: 'JIA',
            method: 'cash',
            split: false,
            filterUser: null
        },
        editingNote: { itemId: null, optionIdx: null, value: '' }
    },

    mapInstance: null,

    init: function() {
        this.render();
        // Load Lucide Icons
        lucide.createIcons();
    },

    setTab: function(tab) {
        this.state.tab = tab;
        this.render();
    },

    setDate: function(date) {
        this.state.selectedDate = date;
        this.render();
    },

    dismissSplash: function() {
        document.getElementById('splash-screen').style.opacity = '0';
        setTimeout(() => {
            document.getElementById('splash-screen').style.display = 'none';
        }, 500);
    },

    // --- Actions ---
    
    // Itinerary Note Actions
    openNoteModal: function(itemId, optionIdx = null, currentNote = '') {
        this.state.editingNote = { itemId, optionIdx, value: currentNote || '' };
        const modal = document.getElementById('note-modal');
        document.getElementById('note-input').value = currentNote || '';
        modal.classList.remove('hidden');
    },

    closeNoteModal: function() {
        document.getElementById('note-modal').classList.add('hidden');
    },

    saveNote: function() {
        const { itemId, optionIdx } = this.state.editingNote;
        const noteValue = document.getElementById('note-input').value;
        
        // Update state
        this.state.itinerary = this.state.itinerary.map(day => {
            const hasItem = day.items.find(i => i.id === itemId);
            if (!hasItem) return day;
            
            const newItems = day.items.map(item => {
                if (item.id === itemId) {
                    if (optionIdx !== null && item.options) {
                        const newOptions = [...item.options];
                        newOptions[optionIdx] = { ...newOptions[optionIdx], notes: noteValue };
                        return { ...item, options: newOptions };
                    }
                    return { ...item, notes: noteValue };
                }
                return item;
            });
            return { ...day, items: newItems };
        });

        this.closeNoteModal();
        this.render();
    },

    // Shopping Actions
    toggleShoppingLocations: function() {
        this.state.shopping.isLocationsExpanded = !this.state.shopping.isLocationsExpanded;
        this.render();
    },
    
    openShoppingItemModal: function(itemId) {
        const item = this.state.shopping.items.find(i => i.id === itemId);
        if (!item) return;
        
        const html = `
            <div class="flex flex-col h-full max-h-[80vh]">
                 <button onclick="App.closeModal()" class="absolute top-4 right-4 p-2 bg-gray-100 rounded-full text-gray-500 z-20">
                    <i data-lucide="x" width="20"></i>
                </button>
                <div class="aspect-[4/3] rounded-2xl bg-gray-100 overflow-hidden mb-5 relative shrink-0">
                     <img src="${item.imageUrl}" class="w-full h-full object-cover">
                </div>
                <h2 class="text-2xl font-serif font-bold text-sabah-dark leading-tight mb-2">${item.name}</h2>
                <div class="text-sm font-bold text-sabah-blue bg-blue-50 px-3 py-1.5 rounded-lg self-start mb-4">
                     ${item.priceEstimate ? 'ÂèÉËÄÉÂÉπÊ†ºÔºö' + item.priceEstimate : 'ÂøÖË≤∑Êé®Ëñ¶'}
                </div>
                <div class="space-y-4 overflow-y-auto">
                    <div>
                        <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">ÁâπËâ≤‰ªãÁ¥π</h4>
                        <p class="text-sm text-gray-600 leading-relaxed">${item.description}</p>
                    </div>
                    ${item.locationHint ? `
                    <div>
                         <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Âì™Ë£°Ë≤∑</h4>
                         <div class="flex items-center gap-2 text-sm text-sabah-dark font-medium">
                            <i data-lucide="map-pin" width="16" class="text-sabah-orange"></i>
                            ${item.locationHint}
                         </div>
                    </div>` : ''}
                </div>
            </div>
        `;
        this.showModal(html);
    },

    // Wallet Actions
    addExpense: function(e) {
        e.preventDefault(); // handled by onclick
        // Get values from form inputs by ID since we aren't using React state binding for form
        const amount = document.getElementById('ex-amount').value;
        const desc = document.getElementById('ex-desc').value;
        
        if (!amount || !desc) return;

        const expense = {
            id: Date.now().toString(),
            amountMYR: parseFloat(amount),
            amountTWD: parseFloat(amount) * EXCHANGE_RATE,
            category: this.state.wallet.cat,
            description: desc,
            date: new Date().toISOString().split('T')[0],
            time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false }),
            payer: this.state.wallet.payer,
            paymentMethod: this.state.wallet.method,
            isSplit: this.state.wallet.split
        };

        this.state.expenses.push(expense);
        
        // Reset form inputs only
        this.state.wallet.amount = '';
        this.state.wallet.desc = '';
        this.state.wallet.split = false;
        
        this.render();
    },

    setWalletState: function(key, val) {
        this.state.wallet[key] = val;
        this.render();
    },

    deleteExpense: function(id) {
        if(confirm('Á¢∫Ë™çÂà™Èô§Ê≠§Á≠ÜÁ¥ÄÈåÑÔºü')) {
            this.state.expenses = this.state.expenses.filter(e => e.id !== id);
            this.render();
        }
    },

    // Info Actions
    toggleChecklist: function(id) {
        this.state.info.checklist = this.state.info.checklist.map(i => 
            i.id === id ? { ...i, checked: !i.checked } : i
        );
        this.render();
    },
    
    addChecklistItem: function() {
        const val = document.getElementById('new-check-item').value;
        if (!val) return;
        this.state.info.checklist.push({ id: Date.now(), text: val, checked: false });
        this.render();
    },

    deleteChecklistItem: function(id) {
        this.state.info.checklist = this.state.info.checklist.filter(i => i.id !== id);
        this.render();
    },

    // Modal Utils
    showModal: function(contentHtml) {
        const container = document.getElementById('modal-container');
        const content = document.getElementById('modal-content');
        content.innerHTML = contentHtml;
        container.classList.remove('hidden');
        // Simple animation
        setTimeout(() => {
            content.classList.remove('scale-95', 'opacity-0');
            content.classList.add('scale-100', 'opacity-100');
        }, 10);
        lucide.createIcons();
    },

    closeModal: function() {
        const container = document.getElementById('modal-container');
        const content = document.getElementById('modal-content');
        content.classList.remove('scale-100', 'opacity-100');
        content.classList.add('scale-95', 'opacity-0');
        setTimeout(() => {
            container.classList.add('hidden');
        }, 300);
    },

    // --- RENDERERS ---

    render: function() {
        const { tab, selectedDate, itinerary } = this.state;
        const currentDay = itinerary.find(d => d.date === selectedDate);

        // 1. Update Background
        const bgLayer = document.getElementById('bg-layer');
        if (tab === 'plan') {
            bgLayer.innerHTML = `<img src="${currentDay.bgImage}" class="w-full h-full object-cover transition-opacity duration-500 opacity-100">`;
        } else {
            bgLayer.innerHTML = `<div class="w-full h-full bg-sabah-bg transition-opacity duration-500"></div>`;
        }

        // 2. Update Header
        const header = document.getElementById('header-container');
        header.innerHTML = this.renderHeader();

        // 3. Update Main Content
        const main = document.getElementById('main-content');
        // Clear previous content? Ideally diff, but full replace for vanilla simplicity
        main.innerHTML = this.renderMainContent();

        // 4. Update Nav
        const nav = document.getElementById('nav-container');
        nav.innerHTML = this.renderNav();

        // Post-render effects
        if (tab === 'map') {
            this.initMap();
        }
        lucide.createIcons();
    },

    renderHeader: function() {
        const { tab, selectedDate, itinerary } = this.state;
        
        if (tab === 'plan') {
             const currentDay = itinerary.find(d => d.date === selectedDate);
             const getWeatherLabel = (cond) => {
                 if(cond.includes('Rain')) return 'Èõ®Â§©';
                 if(cond.includes('Cloud')) return 'Â§öÈõ≤';
                 return 'Êô¥Êúó';
             };
             
             return `
                <div class="px-6 pt-safe pb-4 bg-white/30 backdrop-blur-md sticky top-0 z-30 shadow-sm border-b border-white/20 transition-all">
                    <h1 class="text-2xl font-serif font-black text-sabah-dark tracking-wide mb-4 mt-3 drop-shadow-sm">Sabah | ‰∫ûÂ∫áÊµ∑‰∏≠ÈÅä</h1>
                    <div class="flex items-end justify-between gap-4">
                        <!-- Date Selector -->
                        <div class="flex-1 overflow-x-auto no-scrollbar flex gap-2 snap-x">
                            ${itinerary.map(day => {
                                const isSelected = day.date === selectedDate;
                                const dateObj = new Date(day.date);
                                const dayName = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'][dateObj.getDay()];
                                return `
                                <button onclick="App.setDate('${day.date}')" 
                                    class="flex-shrink-0 w-[42px] h-[54px] rounded-[14px] flex flex-col items-center justify-center border-[1.5px] transition-all snap-center
                                    ${isSelected ? 'bg-sabah-blue border-sabah-blue text-white shadow-md scale-105' : 'bg-white/80 border-transparent text-gray-500'}">
                                    <span class="text-[8px] font-bold uppercase ${isSelected ? 'text-white/80' : 'text-gray-400'}">${dayName}</span>
                                    <span class="text-lg font-serif font-bold leading-none ${isSelected ? 'text-white' : 'text-sabah-dark'}">${dateObj.getDate()}</span>
                                </button>
                                `;
                            }).join('')}
                        </div>
                        
                        <!-- Weather/Info -->
                        <div class="flex flex-col items-end gap-1 mb-1">
                             <div class="text-[10px] font-bold tracking-[0.2em] text-sabah-dark/70 bg-white/50 px-2 py-0.5 rounded-full backdrop-blur-sm">MALAYSIA</div>
                             <div class="flex items-center gap-1.5 bg-white/80 px-2 py-1 rounded-lg backdrop-blur-sm shadow-sm">
                                <i data-lucide="${currentDay.weatherCondition.includes('Rain') ? 'cloud-rain' : currentDay.weatherCondition.includes('Cloud') ? 'cloud' : 'sun'}" 
                                   width="14" class="${currentDay.weatherCondition.includes('Sunny') ? 'text-sabah-yellow' : 'text-gray-500'}"></i>
                                <span class="text-xs font-bold text-sabah-dark">${currentDay.weatherTemp}¬∞</span>
                                <span class="text-[10px] text-gray-500 font-medium">${getWeatherLabel(currentDay.weatherCondition)}</span>
                             </div>
                        </div>
                    </div>
                </div>
             `;
        }
        return ''; // No header for other tabs or handled inside content
    },

    renderMainContent: function() {
        const { tab } = this.state;
        if (tab === 'plan') return this.renderItinerary();
        if (tab === 'map') return '<div id="map-container" class="w-full h-full z-0"></div>';
        if (tab === 'wallet') return this.renderWallet();
        if (tab === 'shopping') return this.renderShopping();
        if (tab === 'info') return this.renderInfo();
        return '';
    },

    renderNav: function() {
        const tabs = [
            { id: 'plan', label: 'Ë°åÁ®ã', icon: 'calendar' },
            { id: 'map', label: 'Âú∞Âúñ', icon: 'map' },
            { id: 'wallet', label: 'Ë®òÂ∏≥', icon: 'wallet' },
            { id: 'shopping', label: 'Ë≥ºÁâ©', icon: 'shopping-bag' },
            { id: 'info', label: 'Ë≥áË®ä', icon: 'info' }
        ];

        return tabs.map(t => {
            const isActive = this.state.tab === t.id;
            return `
                <button onclick="App.setTab('${t.id}')" class="flex flex-col items-center justify-center w-14 transition-all duration-300 gap-1 ${isActive ? 'text-sabah-dark scale-110' : 'text-gray-400'}">
                    <i data-lucide="${t.icon}" width="${isActive ? 24 : 20}" stroke-width="${isActive ? 2.5 : 2}"></i>
                    <span class="text-[9px] font-bold ${isActive ? 'opacity-100' : 'opacity-80'}">${t.label}</span>
                </button>
            `;
        }).join('');
    },

    // --- Sub-Renderers ---

    renderItinerary: function() {
        const day = this.state.itinerary.find(d => d.date === this.state.selectedDate);
        
        let flightHtml = '';
        if (day.flight) {
            flightHtml = `
            <div class="bg-white/90 backdrop-blur-md rounded-[24px] p-5 shadow-card mb-8 border border-white/50 relative overflow-hidden">
                <div class="absolute top-0 left-0 right-0 h-1.5 bg-gradient-to-r from-red-500 to-red-600"></div>
                <div class="flex justify-between items-center mb-6 mt-1">
                    <div class="flex flex-col">
                        <span class="text-4xl font-sans font-bold text-sabah-dark">${day.flight.departureCode}</span>
                        <span class="text-2xl font-serif text-sabah-blue font-bold">${day.flight.departureTime}</span>
                    </div>
                    <div class="flex flex-col items-center flex-1 px-4 text-gray-300">
                         <i data-lucide="plane" class="transform -rotate-45 mb-2" width="32"></i>
                         <div class="w-full h-[1px] bg-gray-300 border-t border-dashed border-gray-400"></div>
                         <span class="text-[10px] text-gray-400 font-bold mt-1">Áõ¥È£õ</span>
                    </div>
                    <div class="flex flex-col items-end">
                         <span class="text-4xl font-sans font-bold text-sabah-dark">${day.flight.arrivalCode}</span>
                         <span class="text-2xl font-serif text-sabah-blue font-bold">${day.flight.arrivalTime}</span>
                    </div>
                </div>
                <div class="flex justify-between items-start text-xs text-gray-500 font-sans mb-4 gap-4">
                     <div class="flex-1 text-left leading-tight">
                        <span class="block font-bold text-sabah-dark">${day.flight.departureAirport.split('ÔΩú')[0]}</span>
                        <span class="block text-[10px] text-gray-400 mt-0.5">${day.flight.departureAirport.split('ÔΩú')[1] || ''}</span>
                     </div>
                     <div class="flex-1 text-right leading-tight">
                        <span class="block font-bold text-sabah-dark">${day.flight.arrivalAirport.split('ÔΩú')[0]}</span>
                        <span class="block text-[10px] text-gray-400 mt-0.5">${day.flight.arrivalAirport.split('ÔΩú')[1] || ''}</span>
                     </div>
                </div>
                <div class="bg-gray-50/80 rounded-xl p-3 flex items-center gap-3 border border-gray-100">
                    <div class="w-6 h-6 flex-shrink-0"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/f/f5/AirAsia_New_Logo.svg/1024px-AirAsia_New_Logo.svg.png" class="w-full h-full object-contain"></div>
                    <div class="flex flex-col">
                         <span class="text-xs font-bold text-sabah-dark">${day.flight.airline}</span>
                         <span class="text-[10px] text-gray-400">${day.flight.aircraft}</span>
                    </div>
                </div>
            </div>`;
        }

        const itemsHtml = day.items.map(item => {
            const timeParts = item.time.split(':');
            const typeColor = item.type === 'food' ? 'bg-sabah-orange' : item.type === 'relax' ? 'bg-sabah-green' : item.type === 'transport' ? 'bg-sabah-yellow' : 'bg-sabah-blue';
            
            let cardContent = '';
            
            if (item.options) {
                // Multi option
                const optionsHtml = item.options.map((opt, idx) => `
                    <div class="min-w-[85%] snap-center bg-white/85 backdrop-blur-md rounded-[24px] p-4 shadow-card border border-white/40 flex flex-col gap-3">
                        <div class="flex gap-3">
                            <div class="flex-1">
                                <h3 class="text-base font-serif font-bold text-sabah-dark mb-2 leading-tight line-clamp-2">${opt.activity}</h3>
                                <a href="https://www.google.com/maps/search/?api=1&query=${opt.coords.lat},${opt.coords.lng}" target="_blank" class="flex items-start gap-1.5 text-gray-500 text-xs hover:text-sabah-blue transition-colors">
                                    <i data-lucide="map-pin" width="12" class="mt-0.5 text-sabah-blue"></i>
                                    <span>${opt.location}</span>
                                </a>
                            </div>
                            ${opt.imageUrl ? `<div class="w-16 h-16 flex-shrink-0 rounded-xl overflow-hidden bg-gray-100"><img src="${opt.imageUrl}" class="w-full h-full object-cover"></div>` : ''}
                        </div>
                        <div class="bg-white/50 p-3 rounded-xl border border-gray-100/50 relative group min-h-[40px]">
                            <p class="text-xs text-gray-500 font-serif font-medium leading-relaxed pr-6">${opt.notes ? 'üí° '+opt.notes : ''}</p>
                            <button onclick="App.openNoteModal('${item.id}', ${idx}, '${opt.notes || ''}')" class="absolute top-2 right-2 p-1 text-gray-300 hover:text-sabah-blue"><i data-lucide="pencil" width="12"></i></button>
                        </div>
                    </div>
                `).join('');
                
                cardContent = `
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 mb-2 px-2">
                             <span className="text-[10px] bg-white/50 text-sabah-orange border border-sabah-orange/20 px-2 py-0.5 rounded-full font-bold uppercase tracking-wider">‰∫åÈÅ∏‰∏Ä</span>
                             <div class="flex-1 h-[1px] bg-white/30"></div>
                             <span class="text-[10px] text-white font-medium flex items-center gap-1 opacity-80">ÂêëÂè≥ÊªëÂãï <i data-lucide="arrow-right" width="10"></i></span>
                        </div>
                        <div class="flex overflow-x-auto gap-4 pb-4 -mx-2 px-2 snap-x no-scrollbar">
                            ${optionsHtml}
                        </div>
                    </div>
                `;
            } else {
                // Single Item
                cardContent = `
                    <div class="flex-1 bg-white/85 backdrop-blur-md rounded-[24px] p-5 shadow-card hover:shadow-soft transition-all duration-300 border border-white/40 flex flex-col gap-3">
                        <div class="flex gap-4">
                            <div class="flex-1">
                                <div class="flex justify-between items-start mb-2">
                                    <div class="flex items-center gap-1.5 text-gray-400 text-[10px] font-bold uppercase tracking-wider">
                                        <i data-lucide="clock" width="10"></i>
                                        ${item.type === 'food' ? 'È§êÈ£≤' : item.type === 'transport' ? '‰∫§ÈÄö' : item.type === 'activity' ? 'Ë°åÁ®ã' : '‰ºëÊÅØ'}
                                    </div>
                                </div>
                                <h3 class="text-lg font-serif font-bold text-sabah-dark mb-2 leading-tight">${item.activity}</h3>
                                <a href="https://www.google.com/maps/search/?api=1&query=${item.coords.lat},${item.coords.lng}" target="_blank" class="flex items-start gap-1.5 text-gray-500 text-xs hover:text-sabah-blue transition-colors mb-1">
                                    <i data-lucide="map-pin" width="12" class="mt-0.5 text-sabah-blue"></i>
                                    <span>${item.location}</span>
                                </a>
                            </div>
                            ${item.imageUrl ? `<div class="w-20 h-20 flex-shrink-0 rounded-2xl overflow-hidden shadow-sm border border-white"><img src="${item.imageUrl}" class="w-full h-full object-cover"></div>` : ''}
                        </div>
                        <div class="bg-white/50 p-3 rounded-xl border border-gray-100/50 relative group min-h-[40px]">
                            <p class="text-xs text-gray-500 font-serif font-medium leading-relaxed pr-6">${item.notes ? 'üí° '+item.notes : '<span class="text-gray-300 italic">ÈªûÊìäÁ∑®ËºØÂÇôË®ª...</span>'}</p>
                            <button onclick="App.openNoteModal('${item.id}', null, '${item.notes || ''}')" class="absolute top-2 right-2 p-1 text-gray-300 hover:text-sabah-blue"><i data-lucide="pencil" width="12"></i></button>
                        </div>
                    </div>
                `;
            }

            return `
                <div class="flex gap-4 group">
                    <div class="flex flex-col items-center pt-1">
                        <div class="w-12 h-12 rounded-[18px] ${typeColor} text-white flex flex-col items-center justify-center shadow-sm z-10">
                            <span class="text-[10px] opacity-80 font-medium leading-none mb-0.5">${timeParts[0]}</span>
                            <span class="text-xs font-bold leading-none">${timeParts[1]}</span>
                        </div>
                    </div>
                    ${cardContent}
                </div>
            `;
        }).join('');

        return `
            <div class="pb-24 pt-4 px-6 relative z-10 animate-fade-in">
                ${flightHtml}
                <div class="space-y-5 relative">
                    <div class="absolute left-[23px] top-6 bottom-6 w-[2px] bg-gray-300/50 -z-10 mix-blend-overlay"></div>
                    ${itemsHtml}
                </div>
            </div>
        `;
    },

    renderWallet: function() {
        const { expenses, wallet } = this.state;
        const filtered = wallet.filterUser ? expenses.filter(e => e.payer === wallet.filterUser) : expenses;
        const totalTWD = filtered.reduce((sum, e) => sum + e.amountTWD, 0);
        const totalMYR = filtered.reduce((sum, e) => sum + e.amountMYR, 0);

        // Split Logic
        const splitExpenses = expenses.filter(e => e.isSplit);
        const totalSplitCost = splitExpenses.reduce((sum, e) => sum + e.amountTWD, 0);
        const jiaPaid = splitExpenses.filter(e => e.payer === 'JIA').reduce((sum, e) => sum + e.amountTWD, 0);
        const diff = jiaPaid - (totalSplitCost / 2);
        const debtor = diff > 0 ? 'KIA' : 'JIA';
        const creditor = diff > 0 ? 'JIA' : 'KIA';
        const debtAmount = Math.abs(diff);

        return `
        <div class="font-sans h-full flex flex-col pt-safe">
            <!-- Cards -->
            <div class="sticky top-0 z-30 bg-sabah-bg/95 backdrop-blur-xl px-6 pb-4 border-b border-gray-100/50 shadow-sm pt-4">
                <div class="flex overflow-x-auto gap-4 pb-1 -mx-2 px-2 snap-x no-scrollbar">
                    
                    <!-- Total -->
                    <div class="min-w-[100%] snap-center bg-sabah-dark rounded-[32px] p-6 text-white shadow-xl relative overflow-hidden flex flex-col justify-between">
                         <div class="absolute -top-10 -right-10 w-48 h-48 bg-sabah-blue rounded-full blur-3xl opacity-20"></div>
                         <div class="absolute -bottom-10 -left-10 w-40 h-40 bg-sabah-orange rounded-full blur-3xl opacity-10"></div>
                         <div class="relative z-10">
                            <div class="flex justify-between items-start mb-2">
                                <h2 class="text-gray-400 text-xs font-bold uppercase tracking-widest">Á∏ΩÊîØÂá∫</h2>
                                <div class="flex gap-1.5">
                                    <button onclick="App.setWalletState('filterUser', null)" class="h-8 px-3 rounded-full text-[10px] font-bold border transition-all ${wallet.filterUser === null ? 'bg-white/20 border-white text-white' : 'border-gray-600 text-gray-400'}">ALL</button>
                                    <button onclick="App.setWalletState('filterUser', 'JIA')" class="w-8 h-8 rounded-full flex items-center justify-center text-[10px] font-bold border transition-all ${wallet.filterUser === 'JIA' ? 'bg-sabah-blue border-sabah-blue text-white' : 'border-gray-600 text-gray-400'}">JIA</button>
                                    <button onclick="App.setWalletState('filterUser', 'KIA')" class="w-8 h-8 rounded-full flex items-center justify-center text-[10px] font-bold border transition-all ${wallet.filterUser === 'KIA' ? 'bg-sabah-orange border-sabah-orange text-white' : 'border-gray-600 text-gray-400'}">KIA</button>
                                </div>
                            </div>
                            <div class="flex items-baseline gap-2 mb-6">
                                <span class="text-lg font-serif text-gray-400">NT$</span>
                                <span class="text-4xl font-sans font-bold tracking-tight">${totalTWD.toLocaleString(undefined, {maximumFractionDigits:0})}</span>
                            </div>
                            <div class="bg-white/10 rounded-2xl p-4 flex items-center justify-between backdrop-blur-md">
                                <div class="flex flex-col">
                                    <span class="text-[10px] text-gray-400 uppercase font-bold">È¶¨Âπ£ MYR</span>
                                    <span class="font-mono text-xl font-medium text-sabah-yellow">RM ${totalMYR.toLocaleString()}</span>
                                </div>
                                <div class="h-8 w-[1px] bg-white/20"></div>
                                <div class="flex flex-col text-right">
                                    <span className="text-[10px] text-gray-400 uppercase font-bold">ÂåØÁéá‰º∞ÁÆó</span>
                                    <span className="font-mono text-xs">1 ‚âà ${EXCHANGE_RATE} TWD</span>
                                </div>
                            </div>
                         </div>
                         <div class="flex justify-end mt-2 items-center gap-1 opacity-50 text-[10px]">
                            <span>ÂêëÂè≥ÊªëÂãïÊü•ÁúãÂàÜÂ∏≥</span> <i data-lucide="arrow-right" width="10"></i>
                        </div>
                    </div>

                    <!-- Split -->
                    <div class="min-w-[100%] snap-center bg-white rounded-[32px] p-6 text-sabah-dark shadow-xl border border-gray-100 flex flex-col justify-between">
                         <div class="flex justify-between items-center mb-6">
                            <h2 class="text-gray-400 text-xs font-bold uppercase tracking-widest">ÂàÜÂ∏≥Âç≥ÊôÇÂõûÈ•ã</h2>
                            <div class="bg-sabah-green/10 text-sabah-green p-2 rounded-full"><i data-lucide="users" width="18"></i></div>
                         </div>
                         ${debtAmount < 1 ? 
                            `<div class="flex flex-col items-center justify-center py-4 text-gray-400 font-bold">ÁõÆÂâçÁµêÊ∏Ö</div>` : 
                            `<div class="flex flex-col items-center justify-center py-2">
                                <div class="flex items-center gap-4 mb-2 w-full justify-between px-4">
                                    <div class="text-center">
                                        <div class="w-12 h-12 rounded-full flex items-center justify-center text-sm font-bold border-4 mx-auto mb-1 ${debtor === 'JIA' ? 'bg-sabah-blue text-white' : 'bg-sabah-orange text-white'}">${debtor}</div>
                                        <span class="text-xs font-bold text-gray-400">ÈúÄÊîØ‰ªò</span>
                                    </div>
                                    <div class="flex-1 flex flex-col items-center">
                                        <span class="text-xs text-gray-400 mb-1">Áµ¶‰∫à</span>
                                        <div class="h-[2px] w-full bg-gray-200"></div>
                                        <span class="font-mono font-bold text-xl mt-1 text-sabah-dark">NT$ ${debtAmount.toFixed(0)}</span>
                                    </div>
                                    <div class="text-center">
                                        <div class="w-12 h-12 rounded-full flex items-center justify-center text-sm font-bold border-4 mx-auto mb-1 ${creditor === 'JIA' ? 'bg-sabah-blue text-white' : 'bg-sabah-orange text-white'}">${creditor}</div>
                                        <span class="text-xs font-bold text-gray-400">Êî∂Ê¨æ</span>
                                    </div>
                                </div>
                            </div>`
                         }
                    </div>

                </div>
            </div>

            <div class="flex-1 px-6 pb-24 pt-4">
                 <!-- Form -->
                 <div class="bg-white rounded-[24px] p-5 shadow-card mb-8">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-sabah-dark font-serif font-bold text-lg">Êñ∞Â¢ûÁ¥ÄÈåÑ</h3>
                        <div class="bg-sabah-bg px-2 py-1 rounded-md text-[10px] font-bold text-sabah-blue">Ëá™ÂãïÊèõÁÆó</div>
                    </div>
                    <div class="bg-sabah-bg rounded-2xl p-4 mb-4 flex items-center gap-4">
                        <div class="flex-1">
                             <label class="text-[10px] font-bold text-gray-400 uppercase block mb-1">MYR ÈáëÈ°ç</label>
                             <div class="flex items-baseline gap-1">
                                <span class="text-sabah-dark font-bold">RM</span>
                                <input id="ex-amount" type="number" class="w-full bg-transparent text-2xl font-bold outline-none" placeholder="0">
                             </div>
                        </div>
                    </div>
                    <input id="ex-desc" type="text" placeholder="Ê∂àË≤ªÈ†ÖÁõÆË™™Êòé" class="w-full bg-white border-b-2 border-gray-100 p-3 text-sm mb-4 outline-none focus:border-sabah-yellow">
                    
                    <div class="flex gap-2 mb-4 overflow-x-auto no-scrollbar py-1">
                        ${['food', 'transport', 'shopping', 'stay', 'other'].map(cat => `
                            <button onclick="App.setWalletState('cat', '${cat}')" class="flex-shrink-0 px-3 py-1.5 rounded-full flex items-center gap-1.5 border transition-all ${wallet.cat === cat ? 'bg-sabah-dark text-white border-sabah-dark' : 'bg-white text-gray-400 border-gray-100'}">
                                <span class="text-[10px] font-bold">${cat === 'food' ? 'È§êÈ£≤' : cat === 'transport' ? '‰∫§ÈÄö' : cat === 'shopping' ? 'Ë≥ºÁâ©' : cat === 'stay' ? '‰ΩèÂÆø' : 'ÂÖ∂‰ªñ'}</span>
                            </button>
                        `).join('')}
                    </div>

                    <div class="flex gap-3 mb-6">
                        <div class="flex bg-sabah-bg rounded-xl p-1">
                            <button onclick="App.setWalletState('payer', 'JIA')" class="px-3 py-2 rounded-lg text-xs font-bold transition-all ${wallet.payer === 'JIA' ? 'bg-sabah-blue text-white shadow-sm' : 'text-gray-400'}">JIA</button>
                            <button onclick="App.setWalletState('payer', 'KIA')" class="px-3 py-2 rounded-lg text-xs font-bold transition-all ${wallet.payer === 'KIA' ? 'bg-sabah-orange text-white shadow-sm' : 'text-gray-400'}">KIA</button>
                        </div>
                        <div class="flex bg-sabah-bg rounded-xl p-1">
                            <button onclick="App.setWalletState('method', 'cash')" class="px-3 py-2 rounded-lg transition-all ${wallet.method === 'cash' ? 'bg-white text-sabah-dark shadow-sm' : 'text-gray-400'}"><i data-lucide="banknote" width="16"></i></button>
                            <button onclick="App.setWalletState('method', 'card')" class="px-3 py-2 rounded-lg transition-all ${wallet.method === 'card' ? 'bg-white text-sabah-dark shadow-sm' : 'text-gray-400'}"><i data-lucide="credit-card" width="16"></i></button>
                        </div>
                        <button onclick="App.setWalletState('split', !App.state.wallet.split)" class="flex-1 rounded-xl flex items-center justify-center gap-2 text-xs font-bold transition-all border ${wallet.split ? 'bg-sabah-green/10 text-sabah-green border-sabah-green' : 'bg-transparent text-gray-400 border-gray-200'}">
                            <i data-lucide="users" width="14"></i> ÂàÜÂ∏≥
                        </button>
                    </div>

                    <button onclick="App.addExpense(event)" class="w-full bg-sabah-yellow text-sabah-dark font-bold py-4 rounded-xl shadow-lg flex items-center justify-center gap-2">
                        <i data-lucide="plus" width="18"></i> Âä†ÂÖ•Èå¢ÂåÖ
                    </button>
                 </div>

                 <!-- List -->
                 <h3 class="text-sabah-dark font-serif font-bold text-lg mb-4 pl-1">ËøëÊúüÊ∂àË≤ª</h3>
                 <div class="space-y-3">
                    ${[...filtered].reverse().map(exp => `
                        <div class="relative bg-white p-4 rounded-2xl shadow-card flex items-center justify-between group">
                             <div class="flex items-center gap-3">
                                <div class="flex flex-col items-center gap-1">
                                     <div class="w-10 h-10 rounded-xl flex items-center justify-center bg-gray-50 text-gray-500">
                                        <i data-lucide="${exp.category === 'food' ? 'coffee' : exp.category === 'transport' ? 'car' : exp.category === 'shopping' ? 'shopping-bag' : exp.category === 'stay' ? 'home' : 'wallet'}" width="18"></i>
                                     </div>
                                     ${exp.isSplit ? '<div class="bg-sabah-green/10 text-sabah-green text-[8px] px-1.5 py-0.5 rounded-full font-bold">ÂàÜÂ∏≥</div>' : ''}
                                </div>
                                <div>
                                    <p class="font-serif font-bold text-sabah-dark text-sm">${exp.description}</p>
                                    <div class="flex items-center gap-2 text-[10px] text-gray-400 font-bold uppercase mt-0.5">
                                        <span class="${exp.payer === 'JIA' ? 'text-sabah-blue' : 'text-sabah-orange'}">${exp.payer}</span>
                                        <span>‚Ä¢</span>
                                        <span>${exp.paymentMethod === 'cash' ? 'ÁèæÈáë' : '‰ø°Áî®Âç°'}</span>
                                    </div>
                                </div>
                             </div>
                             <div class="text-right">
                                <p class="font-bold text-sabah-dark">RM ${exp.amountMYR}</p>
                                <p class="text-xs text-gray-400 font-serif">NT$ ${exp.amountTWD.toFixed(0)}</p>
                             </div>
                             <button onclick="App.deleteExpense('${exp.id}')" class="absolute right-4 top-1/2 -translate-y-1/2 bg-red-500 text-white p-2 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity shadow-lg">
                                <i data-lucide="trash-2" width="16"></i>
                             </button>
                        </div>
                    `).join('')}
                    ${filtered.length === 0 ? '<div class="text-center py-10 text-gray-300 text-sm italic">Â∞öÁÑ°Ê∂àË≤ªÁ¥ÄÈåÑ</div>' : ''}
                 </div>
            </div>
        </div>
        `;
    },

    renderShopping: function() {
        const { locations, items, isLocationsExpanded } = this.state.shopping;
        
        return `
        <div class="px-6 pt-safe pb-32 animate-fade-in">
             <h2 class="text-3xl font-serif font-bold text-sabah-dark mb-6 mt-6">Ë≥ºÁâ©Ê∏ÖÂñÆ</h2>
             
             <!-- Warning -->
             <div class="bg-red-50/90 border border-red-100 rounded-[20px] p-5 mb-8 shadow-sm">
                <div class="flex items-center gap-2 mb-3 text-red-600">
                    <i data-lucide="alert-triangle" width="20"></i>
                    <h3 class="font-bold text-sm">ÂÖ•Â¢ÉÂè∞ÁÅ£Ê≥®ÊÑè‰∫ãÈ†Ö (ÈùûÂ∏∏ÈáçË¶ÅÔºÅ)</h3>
                </div>
                <div class="space-y-3">
                    <div><span class="text-xs font-bold text-red-500 block mb-0.5">ËÇâÈ°ûË£ΩÂìÅÔºöÂö¥Á¶ÅÔºÅ</span><p class="text-[10px] text-gray-600 leading-relaxed">‰ªª‰ΩïË±¨ËÇâË£ΩÂìÅ„ÄÇÂª∫Ë≠∞Áõ°ÈáèÈÅøÂÖçÂ∏∂‰ªª‰ΩïËÇâÈ°û„ÄÇ</p></div>
                    <div><span class="text-xs font-bold text-red-500 block mb-0.5">Êñ∞ÈÆÆÊ∞¥ÊûúÔºö‰∏çËÉΩÂ∏∂ÔºÅ</span><p class="text-[10px] text-gray-600 leading-relaxed">Ê¶¥Êß§„ÄÅÂ±±Á´πÈÉΩ<span class="font-bold underline">‰∏çËÉΩ</span>Â∏∂ÂõûÂè∞ÁÅ£„ÄÇ</p></div>
                </div>
             </div>

             <!-- Locations -->
             <section class="mb-10">
                <div onclick="App.toggleShoppingLocations()" class="flex justify-between items-center mb-4 cursor-pointer select-none">
                    <div class="flex items-center gap-2">
                        <h3 class="text-lg font-serif font-bold text-sabah-dark flex items-center gap-2">
                            <i data-lucide="map-pin" width="18" class="text-sabah-blue"></i> Ë≥ºÁâ©Âú∞Èªû
                        </h3>
                        <i data-lucide="${isLocationsExpanded ? 'chevron-up' : 'chevron-down'}" width="16" class="text-gray-400"></i>
                    </div>
                </div>
                ${isLocationsExpanded ? `
                <div class="flex flex-col gap-3 animate-fade-in">
                    ${locations.map(loc => `
                        <div class="bg-white/90 backdrop-blur-sm rounded-2xl shadow-card border border-white/50 overflow-hidden p-4 flex justify-between gap-4">
                            <div class="flex flex-col justify-start flex-1 min-w-0">
                                <div class="flex items-baseline gap-2 mb-1 flex-wrap">
                                    <h4 class="font-bold text-sabah-dark text-base">${loc.name}</h4>
                                    <span class="text-[10px] text-sabah-blue font-bold uppercase tracking-wider bg-blue-50 px-2 py-0.5 rounded-md whitespace-nowrap">${loc.type}</span>
                                </div>
                                <p class="text-xs text-gray-500 leading-relaxed mb-3">${loc.description}</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(loc.googleMapQuery)}" target="_blank" class="inline-flex items-center gap-1.5 bg-sabah-dark text-white text-[10px] font-bold px-3 py-2 rounded-lg self-start">
                                    <i data-lucide="map-pin" width="12"></i> ÂâçÂæÄ Google Maps
                                </a>
                            </div>
                            <div class="w-20 h-20 rounded-xl bg-gray-100 overflow-hidden flex-shrink-0 border border-gray-100 shadow-sm self-start">
                                <img src="${loc.imageUrl}" class="w-full h-full object-cover">
                            </div>
                        </div>
                    `).join('')}
                </div>` : ''}
             </section>

             <!-- Items -->
             <section>
                <h3 class="text-lg font-serif font-bold text-sabah-dark flex items-center gap-2 mb-4">
                    <i data-lucide="star" width="18" class="text-sabah-yellow"></i> ÂøÖË≤∑Ê∏ÖÂñÆ
                </h3>
                <div class="grid grid-cols-2 gap-4">
                    ${items.map(item => `
                        <div onclick="App.openShoppingItemModal('${item.id}')" class="bg-white/90 backdrop-blur-sm rounded-2xl p-3 shadow-card border border-white/50 flex flex-col h-full cursor-pointer active:scale-[0.98] transition-transform">
                            <div class="aspect-square bg-gray-100 rounded-xl mb-3 overflow-hidden border border-gray-100 relative">
                                <img src="${item.imageUrl}" class="w-full h-full object-cover">
                                ${item.rating > 0 ? `<div class="absolute top-1 right-1 bg-white/90 backdrop-blur-md px-1.5 py-0.5 rounded-full flex items-center gap-0.5 shadow-sm"><i data-lucide="star" width="8" class="text-sabah-yellow fill-sabah-yellow"></i><span class="text-[8px] font-bold">${item.rating}</span></div>` : ''}
                            </div>
                            <h4 class="font-bold text-sabah-dark text-xs mb-1 line-clamp-1">${item.name}</h4>
                            <p class="text-[10px] text-gray-500 mb-2 leading-tight line-clamp-2 flex-grow">${item.description}</p>
                            ${item.priceEstimate ? `<div class="text-[10px] font-bold text-sabah-blue bg-blue-50 px-2 py-1 rounded-md self-start">${item.priceEstimate}</div>` : ''}
                        </div>
                    `).join('')}
                </div>
             </section>
        </div>
        `;
    },

    renderInfo: function() {
        const { checklist } = this.state.info;
        return `
        <div class="px-6 pt-safe pb-24 animate-fade-in space-y-4">
            <h2 className="text-3xl font-serif font-bold text-sabah-dark mb-6 mt-6">ÊóÖÈÅäË≥áË®ä</h2>

            <div class="bg-white/90 backdrop-blur-sm p-5 rounded-[24px] shadow-card border border-white/50">
                <div class="flex items-center gap-3 mb-3">
                    <div class="p-2 bg-gray-100 text-sabah-dark rounded-full"><i data-lucide="file-text" width="20" class="text-sabah-blue"></i></div>
                    <h3 class="font-bold text-sabah-dark">1. ÂÖ•Â¢ÉËàáÁ∞ΩË≠â (ÂøÖËæ¶ÔºÅ)</h3>
                </div>
                <div class="text-sm text-gray-600 leading-relaxed font-sans space-y-2">
                    <p><strong class="text-sabah-dark">ÈõªÂ≠êÂÖ•Â¢ÉÂç° (MDAC)Ôºö</strong> ÈõñÂÖçÁ∞Ω‰ΩÜÂº∑Âà∂Â°´ÂØ´„ÄÇ</p>
                    <ul class="list-disc pl-4 space-y-1">
                        <li><strong class="text-gray-500">ÊôÇÈñìÔºö</strong> ÊäµÈÅîÂâç 3Â§©ÂÖß (Âê´Áï∂Êó•)„ÄÇ</li>
                        <li><strong class="text-gray-500">ÊñπÂºèÔºö</strong> Â°´ÂØ´ÂæåÊ™¢Êü• EmailÔºåÊà™ÂúñÂÇôÊü•„ÄÇ</li>
                    </ul>
                </div>
            </div>

            <!-- More info cards could go here similar to React structure -->

            <div class="bg-sabah-dark text-white p-5 rounded-[24px] shadow-lg">
                <h3 class="font-bold font-serif text-lg mb-4 flex items-center gap-2">
                    <i data-lucide="check" width="20" class="text-sabah-green"></i> Âá∫ÁôºÂâçÊúÄÂæåÊ™¢Êü• List
                </h3>
                <div class="space-y-2 mb-4">
                    ${checklist.map(item => `
                        <div class="flex items-start gap-3 p-3 bg-white rounded-xl border border-gray-100 shadow-sm group">
                            <button onclick="App.toggleChecklist(${item.id})" class="w-5 h-5 rounded-md border flex items-center justify-center flex-shrink-0 mt-0.5 ${item.checked ? 'bg-sabah-green border-sabah-green text-white' : 'bg-transparent border-gray-300'}">
                                ${item.checked ? '<i data-lucide="check" width="14"></i>' : ''}
                            </button>
                            <span class="text-sm flex-1 ${item.checked ? 'text-gray-400 line-through' : 'text-sabah-dark'}">${item.text}</span>
                            <button onclick="App.deleteChecklistItem(${item.id})" class="text-gray-300 hover:text-red-400"><i data-lucide="trash-2" width="16"></i></button>
                        </div>
                    `).join('')}
                </div>
                <div class="flex gap-2">
                    <input id="new-check-item" type="text" placeholder="Êñ∞Â¢ûÈ†ÖÁõÆ..." class="flex-1 bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-sm text-white placeholder-gray-400 outline-none">
                    <button onclick="App.addChecklistItem()" class="bg-sabah-blue text-white p-3 rounded-xl"><i data-lucide="plus" width="20"></i></button>
                </div>
            </div>
        </div>
        `;
    },

    // --- MAP LOGIC ---
    initMap: function() {
        if (this.mapInstance) {
            this.mapInstance.remove();
            this.mapInstance = null;
        }

        const mapContainer = document.getElementById('map-container');
        if (!mapContainer) return;

        const day = this.state.itinerary.find(d => d.date === this.state.selectedDate);
        // Default JQ
        const defaultCenter = [5.9904, 116.0798];
        
        const map = L.map('map-container', { zoomControl: false }).setView(defaultCenter, 13);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: 'OpenStreetMap'
        }).addTo(map);

        // Icons
        const customIcon = L.icon({
            iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
            iconRetinaUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png',
            shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
            iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
        });

        const houseIcon = L.divIcon({
            className: 'custom-house-icon',
            html: `<div><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg></div>`,
            iconSize: [32, 32], iconAnchor: [16, 32], popupAnchor: [0, -34]
        });

        // Markers
        const bounds = [];
        
        // Accommodation (Persistent)
        const jqMarker = L.marker(defaultCenter, { icon: houseIcon }).addTo(map)
            .bindPopup(`<b>‰ΩèÂÆøÔºöJesselton Quay</b><br><a href="https://maps.google.com/?q=${defaultCenter[0]},${defaultCenter[1]}" target="_blank">Google Maps</a>`);
        bounds.push(defaultCenter);

        // Itinerary Markers
        day.items.forEach(item => {
            const addMarker = (lat, lng, title, locName) => {
                L.marker([lat, lng], { icon: customIcon }).addTo(map)
                    .bindPopup(`<b>${title}</b><br><span style="font-size:10px;color:gray">${locName}</span><br><a href="https://maps.google.com/?q=${lat},${lng}" target="_blank">Google Maps</a>`);
                bounds.push([lat, lng]);
            };

            addMarker(item.coords.lat, item.coords.lng, item.activity, item.location);
            
            if(item.options) {
                item.options.forEach(opt => addMarker(opt.coords.lat, opt.coords.lng, opt.activity, opt.location));
            }
        });

        if (bounds.length > 0) {
            map.fitBounds(bounds, { padding: [50, 50], maxZoom: 15 });
        }

        this.mapInstance = map;
    }
};

// Initialize App
document.addEventListener('DOMContentLoaded', () => {
    App.init();
});

</script>
<script type="module" src="/index.tsx"></script>
</body>
</html>