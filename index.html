
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Sabah Travel Companion</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Noto+Serif+TC:wght@500;700;900&display=swap" rel="stylesheet">

    <!-- Configuration -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              sabah: {
                bg: '#F9F9F7',
                yellow: '#F3C969',
                orange: '#F26B3A',
                blue: '#0077BE',
                lightblue: '#89CFF0',
                green: '#508A75',
                dark: '#2D3436',
                gray: '#A0A0A0'
              }
            },
            fontFamily: {
              serif: ['"Noto Serif TC"', 'serif'],
              sans: ['"Noto Sans TC"', 'sans-serif'],
            },
            boxShadow: {
              'soft': '0 10px 40px -10px rgba(0,0,0,0.08)',
              'card': '0 4px 20px -2px rgba(0,0,0,0.05)'
            }
          }
        }
      }
    </script>

    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #111827; /* Dark background for desktop outer */
            overscroll-behavior-y: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Mobile Frame */
        #app-frame {
            background-color: #F9F9F7;
            max-width: 480px;
            margin: 0 auto;
            min-height: 100dvh;
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        /* Utilities */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .pt-safe { padding-top: env(safe-area-inset-top, 20px); }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom, 20px); }
        
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Leaflet Overrides */
        .leaflet-pane { z-index: 0 !important; }
        .leaflet-bottom { z-index: 1000 !important; }

        /* Custom Markers */
        .custom-user-location {
            background-color: #0077BE;
            width: 18px; height: 18px; border-radius: 50%;
            border: 3px solid white; box-shadow: 0 0 15px rgba(0, 119, 190, 0.5);
        }
        .custom-house-icon {
            background-color: #F26B3A; color: white;
            width: 32px; height: 32px; border-radius: 50%; border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            display: flex; align-items: center; justify-content: center;
        }

        /* Drag & Drop Visuals */
        .dragging {
            opacity: 0.5;
            background: #f3f4f6;
            border: 2px dashed #ccc;
        }
        
        /* Long Press Progress Bar */
        .progress-bar-container {
            position: absolute; top: 0; left: 0; height: 4px; 
            background: #0077BE; transition: width 0.05s linear;
        }
    </style>
<script type="importmap">
{
  "imports": {
    "react/": "https://esm.sh/react@^19.2.1/",
    "react": "https://esm.sh/react@^19.2.1",
    "react-router-dom": "https://esm.sh/react-router-dom@^7.10.1",
    "react-leaflet": "https://esm.sh/react-leaflet@^5.0.0",
    "react-dom/": "https://esm.sh/react-dom@^19.2.1/",
    "leaflet": "https://esm.sh/leaflet@^1.9.4",
    "lucide-react": "https://esm.sh/lucide-react@^0.560.0"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
<body>

    <div id="app-frame">
        <!-- Splash Screen -->
        <div id="splash-screen" class="fixed inset-0 z-[100] cursor-pointer bg-black flex items-center justify-center transition-opacity duration-700" onclick="dismissSplash()">
            <img src="https://i.pinimg.com/736x/a1/68/29/a168297e14852587d40f2ac06dd2a1e5.jpg" class="absolute inset-0 w-full h-full object-cover opacity-90">
            <div class="absolute inset-0 bg-black/20 backdrop-blur-[2px]"></div>
            <div class="relative text-white text-center z-10 animate-fade-in space-y-4">
                <p class="text-xl font-sans tracking-[0.3em] font-light uppercase opacity-90">Welcome to</p>
                <h1 class="text-6xl font-serif font-black tracking-wider drop-shadow-2xl">SABAH</h1>
                <div class="w-12 h-1 bg-white/80 mx-auto rounded-full mt-6"></div>
                <p class="text-xs font-sans mt-8 opacity-70 animate-pulse">é»æ“Šä»»æ„è™•é–‹å§‹</p>
            </div>
        </div>

        <!-- Dynamic Background -->
        <div id="bg-layer" class="absolute inset-0 z-0 transition-opacity duration-700">
            <img id="bg-image" src="" class="w-full h-full object-cover hidden">
            <div class="absolute inset-0 bg-white/20 backdrop-blur-[1px]"></div>
        </div>

        <!-- Header (Visible only in Plan) -->
        <header id="main-header" class="relative z-20 bg-white/30 backdrop-blur-md shadow-sm border-b border-white/20 pb-2 hidden">
            <div class="pt-safe pb-1 text-center mb-2">
                <h2 class="text-2xl font-serif font-bold text-sabah-dark drop-shadow-sm mt-3">Sabah | äºåº‡æµ·ä¸­éŠ</h2>
            </div>
            <div class="flex items-center justify-between px-2">
                <div id="date-selector" class="flex-1 overflow-x-auto gap-2 px-1 pb-1 no-scrollbar flex snap-x">
                    <!-- Date buttons injected here -->
                </div>
                <div class="flex flex-col items-end pl-2 pr-4 gap-1 min-w-[80px]">
                    <span class="bg-sabah-blue/90 text-white px-2 py-0.5 rounded-full text-[10px] font-bold tracking-wide shadow-sm">MALAYSIA</span>
                    <div class="flex items-center gap-1.5 bg-white/90 px-2 py-1 rounded-lg shadow-sm">
                        <i data-lucide="sun" class="w-4 h-4 text-sabah-yellow"></i>
                        <div class="flex flex-col items-end leading-none">
                            <span id="weather-temp" class="text-xs font-bold text-sabah-dark">--Â°C</span>
                            <span id="weather-cond" class="text-[8px] text-gray-400 font-medium">--</span>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main id="main-content" class="flex-1 overflow-y-auto no-scrollbar relative z-10">
            <!-- Sections will be toggled here -->
            <div id="view-plan" class="p-4 space-y-4"></div>
            <div id="view-map" class="h-full w-full hidden">
                <div id="map-container" class="w-full h-full bg-gray-200"></div>
            </div>
            <div id="view-wallet" class="p-6 hidden pt-safe"></div>
            <div id="view-shopping" class="p-6 hidden pt-safe pb-32"></div>
            <div id="view-info" class="p-6 hidden pt-safe pb-24 space-y-4"></div>
        </main>

        <!-- Navigation -->
        <nav class="relative z-50 bg-white/95 backdrop-blur-xl border-t border-gray-100 pb-safe shadow-[0_-10px_40px_rgba(0,0,0,0.05)]">
            <div class="flex justify-between items-center px-4 py-2">
                <button onclick="switchTab('plan')" class="nav-btn flex flex-col items-center gap-1 w-full text-sabah-blue" data-tab="plan">
                    <div class="icon-container p-1.5 rounded-2xl bg-blue-50/80 scale-110 -translate-y-1 transition-all"><i data-lucide="calendar"></i></div>
                    <span class="text-[10px] font-bold scale-110 transition-all">è¡Œç¨‹</span>
                </button>
                <button onclick="switchTab('map')" class="nav-btn flex flex-col items-center gap-1 w-full text-gray-400" data-tab="map">
                    <div class="icon-container p-1.5 rounded-2xl bg-transparent transition-all"><i data-lucide="map"></i></div>
                    <span class="text-[10px] font-bold scale-100 transition-all">åœ°åœ–</span>
                </button>
                <button onclick="switchTab('wallet')" class="nav-btn flex flex-col items-center gap-1 w-full text-gray-400" data-tab="wallet">
                    <div class="icon-container p-1.5 rounded-2xl bg-transparent transition-all"><i data-lucide="wallet"></i></div>
                    <span class="text-[10px] font-bold scale-100 transition-all">è¨˜å¸³</span>
                </button>
                <button onclick="switchTab('shopping')" class="nav-btn flex flex-col items-center gap-1 w-full text-gray-400" data-tab="shopping">
                    <div class="icon-container p-1.5 rounded-2xl bg-transparent transition-all"><i data-lucide="shopping-bag"></i></div>
                    <span class="text-[10px] font-bold scale-100 transition-all">è³¼ç‰©</span>
                </button>
                <button onclick="switchTab('info')" class="nav-btn flex flex-col items-center gap-1 w-full text-gray-400" data-tab="info">
                    <div class="icon-container p-1.5 rounded-2xl bg-transparent transition-all"><i data-lucide="info"></i></div>
                    <span class="text-[10px] font-bold scale-100 transition-all">è³‡è¨Š</span>
                </button>
            </div>
        </nav>

        <!-- Hidden File Input for Image Upload -->
        <input type="file" id="image-upload-input" accept="image/*" class="hidden">
    </div>

    <!-- Scripts -->
    <script>
        // --- 1. Constants & Data ---
        const LOCATIONS = {
            BKI_AIRPORT: { lat: 5.9375, lng: 116.0510, name: "äºåº‡åœ‹éš›æ©Ÿå ´ (BKI)" },
            JESSELTON_QUAY: { lat: 5.9904, lng: 116.0798, name: "Jesselton Quay (JQ)" },
            BORENOS_CHICKEN: { lat: 5.9760, lng: 116.0738, name: "Borenos Fried Chicken" },
            FOOK_YUEN_GAYA: { lat: 5.9845, lng: 116.0775, name: "å¯ŒæºèŒ¶é¤å»³ Fook Yuen" },
            YEE_FUNG_LAKSA: { lat: 5.9830, lng: 116.0770, name: "æ€¡è±èŒ¶å®¤ Yee Fung Laksa" },
            WISMA_MERDEKA: { lat: 5.9856, lng: 116.0777, name: "Wisma Merdeka" },
            JESSELTON_POINT: { lat: 5.9890, lng: 116.0780, name: "Jesselton Point ç¢¼é ­" },
            MANUKAN_ISLAND: { lat: 5.9644, lng: 116.0076, name: "Manukan é¦¬åŠªå¹²å³¶" },
            SAPI_ISLAND: { lat: 5.9606, lng: 116.0048, name: "Sapi æ²™æ¯”å³¶" },
            YU_KEE_BAK_KUT_TEH: { lat: 5.9840, lng: 116.0772, name: "ä½‘è¨˜è‚‰éª¨èŒ¶ Yu Kee" },
            SIN_KEE_BAK_KUT_TEH: { lat: 5.9825, lng: 116.0770, name: "æ–°è¨˜è‚‰éª¨èŒ¶ Sin Kee" },
            API_API_NIGHT_MARKET: { lat: 5.9835, lng: 116.0772, name: "åŠ é›…è¡—å¤œå¸‚" },
            WOO_CAFE: { lat: 5.9818, lng: 116.0785, name: "Woo! Cafe" },
            GUANS_KOPITIAM: { lat: 5.9835, lng: 116.0775, name: "æºèŒ¶å®¤ Guan's Kopitiam" },
            UMS_MOSQUE: { lat: 6.0367, lng: 116.1186, name: "æ²™å·´å¤§å­¸ç²‰ç´…æ¸…çœŸå¯º" },
            JIA_XIANG_LINTAS: { lat: 5.9490, lng: 116.0920, name: "å®¶é¦™ç”Ÿè‚‰éºµ" },
            IMAGO_MALL: { lat: 5.9705, lng: 116.0667, name: "Imago Shopping Mall" },
            TANJUNG_ARU_BEACH: { lat: 5.9482, lng: 116.0447, name: "ä¸¹çµ¨äºè·¯æµ·ç˜ Beach 2" },
            WELCOME_SEAFOOD: { lat: 5.9765, lng: 116.0740, name: "å¤§èŒ„ä¾†æµ·é®®" },
            KAMA_SPA: { lat: 5.9815, lng: 116.0782, name: "Kama'A Spa" }
        };

        const INITIAL_ITINERARY = [
            {
                date: '2026-01-09', weatherTemp: 27, weatherCondition: 'Cloudy',
                bgImage: 'https://i.pinimg.com/736x/a4/ae/3f/a4ae3f8d0c49e9cbf2e725a42e6d24ba.jpg',
                flight: { departureTime: '19:15', departureCode: 'TPE', departureAirport: 'TPE T1', arrivalTime: '22:50', arrivalCode: 'BKI', arrivalAirport: 'BKI T1', airline: 'AirAsia', aircraft: 'A320' },
                items: [
                    { id: '1-1', time: '22:30', duration: 40, activity: 'æŠµé”äºåº‡åœ‹éš›æ©Ÿå ´', location: 'BKI Airport', coords: LOCATIONS.BKI_AIRPORT, type: 'transport', travelTime: 'Grab 20åˆ†' },
                    { id: '1-2', time: '23:30', duration: 20, activity: 'æŠµé”ä½å®¿', location: 'Jesselton Quay', coords: LOCATIONS.JESSELTON_QUAY, type: 'relax', travelTime: 'æ•´ç†' },
                    { id: '1-3', time: '23:50', duration: 60, activity: 'å®µå¤œ (äºŒé¸ä¸€)', location: 'Swipe Options', coords: LOCATIONS.BORENOS_CHICKEN, type: 'food', options: [
                        { activity: 'Borenos Fried Chicken', location: 'Asia City', coords: LOCATIONS.BORENOS_CHICKEN, notes: 'å¥½åƒç‚¸é›' },
                        { activity: 'å¯ŒæºèŒ¶é¤å»³', location: 'Gaya St', coords: LOCATIONS.FOOK_YUEN_GAYA, notes: 'å’–æ¤°åå¸' }
                    ]}
                ]
            },
            {
                date: '2026-01-10', weatherTemp: 31, weatherCondition: 'Sunny',
                bgImage: 'https://i.pinimg.com/1200x/39/b4/aa/39b4aa96ca7fe7de41f28623af1eaf8b.jpg',
                items: [
                    { id: '2-0', time: '09:00', duration: 0, activity: 'å¾ä½å®¿å‡ºç™¼', location: 'JQ', coords: LOCATIONS.JESSELTON_QUAY, type: 'transport', travelTime: 'Grab 15åˆ†' },
                    { id: '2-1', time: '09:15', duration: 45, activity: 'æ—©é¤ï¼šæ€¡è±èŒ¶å®¤', location: 'Gaya St', coords: LOCATIONS.YEE_FUNG_LAKSA, type: 'food', notes: 'å»æ²™ Laksa', travelTime: 'æ­¥è¡Œ 5åˆ†' },
                    { id: '2-2', time: '10:00', duration: 30, activity: 'æ›éŒ¢', location: 'Wisma Merdeka', coords: LOCATIONS.WISMA_MERDEKA, type: 'activity', notes: 'åŒ¯ç‡æœ€å¥½', travelTime: 'æ­¥è¡Œ 5åˆ†' },
                    { id: '2-3', time: '10:30', duration: 30, activity: 'å‡ºæµ·ç¢¼é ­', location: 'Jesselton Point', coords: LOCATIONS.JESSELTON_POINT, type: 'transport', notes: 'è³¼ç¥¨', travelTime: 'èˆ¹ç¨‹ 20åˆ†' },
                    { id: '2-4a', time: '11:00', duration: 120, activity: 'é¦¬åŠªå¹²å³¶', location: 'Manukan', coords: LOCATIONS.MANUKAN_ISLAND, type: 'activity', notes: 'é™½å…‰æ²™ç˜', travelTime: 'æ›å³¶' },
                    { id: '2-4b', time: '13:00', duration: 120, activity: 'æ²™æ¯”å³¶', location: 'Sapi', coords: LOCATIONS.SAPI_ISLAND, type: 'activity', notes: 'æµ®æ½›', travelTime: 'è¿”å›' },
                    { id: '2-5', time: '19:00', duration: 75, activity: 'æ™šé¤ï¼šè‚‰éª¨èŒ¶', location: 'Gaya St', coords: LOCATIONS.YU_KEE_BAK_KUT_TEH, type: 'food', travelTime: 'æ­¥è¡Œ 3åˆ†', options: [
                        { activity: 'ä½‘è¨˜è‚‰éª¨èŒ¶', location: 'Gaya St', coords: LOCATIONS.YU_KEE_BAK_KUT_TEH },
                        { activity: 'æ–°è¨˜è‚‰éª¨èŒ¶', location: 'Pantai St', coords: LOCATIONS.SIN_KEE_BAK_KUT_TEH }
                    ]},
                    { id: '2-6', time: '20:15', duration: 60, activity: 'åŠ é›…è¡—å¤œå¸‚', location: 'Gaya St', coords: LOCATIONS.API_API_NIGHT_MARKET, type: 'activity', notes: 'é€±äº”å…­é™å®š' }
                ]
            },
            {
                date: '2026-01-11', weatherTemp: 29, weatherCondition: 'Cloudy',
                bgImage: 'https://i.pinimg.com/1200x/fd/d5/18/fdd5185cbab77d2e1abf50b54b1fc656.jpg',
                items: [
                    { id: '3-0', time: '10:30', duration: 0, activity: 'å¾ä½å®¿å‡ºç™¼', location: 'JQ', coords: LOCATIONS.JESSELTON_QUAY, type: 'transport', travelTime: 'Grab 15åˆ†' },
                    { id: '3-1', time: '10:45', duration: 90, activity: 'æ—©åˆé¤', location: 'Lorong Dewan', coords: LOCATIONS.WOO_CAFE, type: 'food', travelTime: 'è»Šç¨‹ 90åˆ†', options: [
                        { activity: 'Woo! Cafe', location: 'Lorong Dewan', coords: LOCATIONS.WOO_CAFE },
                        { activity: "Guan's Kopitiam", location: 'Gaya St', coords: LOCATIONS.GUANS_KOPITIAM }
                    ]},
                    { id: '3-2', time: '13:30', duration: 360, activity: 'é•·é¼»çŒ´ & è¢ç«èŸ²', location: 'Kawa Kawa', coords: LOCATIONS.JESSELTON_QUAY, type: 'activity', notes: 'æ—…è¡Œç¤¾æ¥é€', travelTime: 'è»Šç¨‹ 90åˆ†' },
                    { id: '3-3', time: '21:30', duration: 60, activity: 'å®µå¤œ', location: 'å¯Œæº', coords: LOCATIONS.FOOK_YUEN_GAYA, type: 'food' }
                ]
            },
            {
                date: '2026-01-12', weatherTemp: 32, weatherCondition: 'Sunny',
                bgImage: 'https://i.pinimg.com/1200x/3d/2b/b9/3d2bb9a9e3ebc71f0b73692f93e19633.jpg',
                items: [
                    { id: '4-0', time: '10:40', duration: 0, activity: 'å¾ä½å®¿å‡ºç™¼', location: 'JQ', coords: LOCATIONS.JESSELTON_QUAY, type: 'transport', travelTime: 'Grab 20åˆ†' },
                    { id: '4-1', time: '11:00', duration: 60, activity: 'ç²‰ç´…æ¸…çœŸå¯º', location: 'UMS', coords: LOCATIONS.UMS_MOSQUE, type: 'activity', notes: 'ç©¿è‘—å¾—é«”', travelTime: 'Grab 20åˆ†' },
                    { id: '4-2', time: '12:30', duration: 60, activity: 'åˆé¤ï¼šå®¶é¦™ç”Ÿè‚‰éºµ', location: 'Lintas', coords: LOCATIONS.JIA_XIANG_LINTAS, type: 'food', travelTime: 'Grab 15åˆ†' },
                    { id: '4-3', time: '14:00', duration: 180, activity: 'Imago è³¼ç‰©', location: 'Imago Mall', coords: LOCATIONS.IMAGO_MALL, type: 'activity', notes: 'Padini, Bata', travelTime: 'Grab 15åˆ†' },
                    { id: '4-4', time: '17:30', duration: 90, activity: 'ä¸¹çµ¨äºè·¯å¤•é™½', location: 'Tanjung Aru', coords: LOCATIONS.TANJUNG_ARU_BEACH, type: 'relax', notes: 'ä¸–ç•Œä¸‰å¤§å¤•é™½', travelTime: 'Grab 15åˆ†' },
                    { id: '4-5', time: '19:30', duration: 90, activity: 'æ™šé¤ï¼šå¤§èŒ„ä¾†æµ·é®®', location: 'Asia City', coords: LOCATIONS.WELCOME_SEAFOOD, type: 'food', notes: 'æ¿•å¥¶æ²¹è€è™è¦', travelTime: 'æ­¥è¡Œ 5åˆ†' },
                    { id: '4-6', time: '21:30', duration: 30, activity: 'æŒ‰æ‘©', location: 'Kama Spa', coords: LOCATIONS.KAMA_SPA, type: 'relax' }
                ]
            },
            {
                date: '2026-01-13', weatherTemp: 26, weatherCondition: 'Rain',
                bgImage: 'https://i.pinimg.com/736x/7e/22/3f/7e223f12849b463bc9ce8caf19b59e53.jpg',
                flight: { departureTime: '07:40', departureCode: 'BKI', departureAirport: 'BKI T1', arrivalTime: '10:55', arrivalCode: 'TPE', arrivalAirport: 'TPE T1', airline: 'AirAsia', aircraft: 'A320' },
                items: [
                    { id: '5-1', time: '04:45', duration: 15, activity: 'èµ·åºŠ & é€€æˆ¿', location: 'JQ', coords: LOCATIONS.JESSELTON_QUAY, type: 'relax', travelTime: 'Grab 20åˆ†' },
                    { id: '5-2', time: '05:00', duration: 0, activity: 'å‡ºç™¼å»æ©Ÿå ´', location: 'BKI Airport', coords: LOCATIONS.BKI_AIRPORT, type: 'transport', notes: 'å›å®¶ âœˆï¸' }
                ]
            }
        ];

        const SHOPPING_ITEMS = [
            { id: 1, name: "æ²™å·´ç´…èŒ¶", rating: 5, imageUrl: "https://images.unsplash.com/photo-1597481499750-3e6b22637e12?q=80&w=200" },
            { id: 2, name: "Eureka çˆ†ç±³èŠ±", rating: 5, imageUrl: "https://images.unsplash.com/photo-1578849278619-e73505e9610f?q=80&w=200" },
            { id: 3, name: "Bata é‹å­", rating: 4, imageUrl: "https://images.unsplash.com/photo-1595950653106-6c9ebd614d3a?q=80&w=200" },
            { id: 4, name: "Fipper å¤¾è…³æ‹–", rating: 5, imageUrl: "https://images.unsplash.com/photo-1562124638-724e13052aaf?q=80&w=200" }
        ];

        const EXCHANGE_RATE = 7.5;

        // --- 2. State Management ---
        let appState = {
            activeTab: 'plan',
            selectedDate: INITIAL_ITINERARY[0].date,
            dayPlans: JSON.parse(JSON.stringify(INITIAL_ITINERARY)), // Deep copy
            expenses: [],
            isEditingId: null, // For itinerary cards
            map: null // Leaflet instance
        };

        // --- 3. Logic & Helpers ---
        function parseTime(timeStr) {
            const [h, m] = timeStr.split(':').map(Number);
            return h * 60 + m;
        }

        function formatTime(minutes) {
            const h = Math.floor(minutes / 60) % 24;
            const m = minutes % 60;
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
        }

        function parseTravelTime(str) {
            if (!str) return 0;
            const match = str.match(/(\d+)/);
            return match ? parseInt(match[1]) : 0;
        }

        function recalculateSchedule(dayPlan) {
            if (!dayPlan.items.length) return;
            
            // Start time based on first item
            let currentMinutes = parseTime(dayPlan.items[0].time);
            
            for (let i = 0; i < dayPlan.items.length; i++) {
                if (i === 0) {
                    currentMinutes = parseTime(dayPlan.items[i].time);
                } else {
                    const prevItem = dayPlan.items[i-1];
                    const prevDuration = prevItem.duration || 60;
                    const travel = parseTravelTime(prevItem.travelTime);
                    const newStart = parseTime(prevItem.time) + prevDuration + travel;
                    
                    dayPlan.items[i].time = formatTime(newStart);
                }
            }
        }

        function dismissSplash() {
            const splash = document.getElementById('splash-screen');
            splash.style.opacity = '0';
            setTimeout(() => {
                splash.style.display = 'none';
                renderApp();
            }, 500);
        }

        function switchTab(tab) {
            appState.activeTab = tab;
            
            // Update UI
            document.querySelectorAll('.nav-btn').forEach(btn => {
                const isActive = btn.dataset.tab === tab;
                const iconContainer = btn.querySelector('.icon-container');
                const label = btn.querySelector('span');
                const icon = btn.querySelector('i');
                
                btn.className = `nav-btn flex flex-col items-center gap-1 w-full transition-all duration-300 ${isActive ? 'text-sabah-blue' : 'text-gray-400'}`;
                iconContainer.className = `icon-container p-1.5 rounded-2xl transition-all duration-300 ${isActive ? 'bg-blue-50/80 scale-110 -translate-y-1' : 'bg-transparent'}`;
                label.className = `text-[10px] font-bold transition-all duration-300 ${isActive ? 'scale-110' : 'scale-100'}`;
                
                // Re-render icon to update stroke width
                if(isActive) icon.setAttribute('stroke-width', '2.5');
                else icon.setAttribute('stroke-width', '2');
            });
            lucide.createIcons();

            // Hide all views
            ['plan', 'map', 'wallet', 'shopping', 'info'].forEach(t => {
                document.getElementById(`view-${t}`).classList.add('hidden');
            });

            // Show active view
            document.getElementById(`view-${tab}`).classList.remove('hidden');

            // Specific logic per tab
            const header = document.getElementById('main-header');
            const bgLayer = document.getElementById('bg-layer');
            const bgImage = document.getElementById('bg-image');
            
            if (tab === 'plan') {
                header.classList.remove('hidden');
                bgLayer.classList.remove('hidden');
                bgImage.classList.remove('hidden');
                const plan = appState.dayPlans.find(d => d.date === appState.selectedDate);
                if(plan) bgImage.src = plan.bgImage;
                renderPlan();
            } else {
                header.classList.add('hidden');
                bgLayer.classList.add('hidden'); // Clean background for other tabs
                if (tab === 'map') initMap();
                if (tab === 'wallet') renderWallet();
                if (tab === 'shopping') renderShopping();
                if (tab === 'info') renderInfo();
            }
        }

        // --- 4. Render Logic ---

        // PLAN RENDERER
        function renderPlan() {
            const container = document.getElementById('view-plan');
            const plan = appState.dayPlans.find(d => d.date === appState.selectedDate);
            if (!plan) return;

            // Update Header Info
            document.getElementById('weather-temp').innerText = `${plan.weatherTemp}Â°C`;
            document.getElementById('weather-cond').innerText = plan.weatherCondition;

            // Render Date Selector
            const dateContainer = document.getElementById('date-selector');
            dateContainer.innerHTML = appState.dayPlans.map(d => {
                const dateObj = new Date(d.date);
                const dayName = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][dateObj.getDay()];
                const isSelected = d.date === appState.selectedDate;
                return `
                    <button onclick="selectDate('${d.date}')" class="flex-shrink-0 flex flex-col items-center justify-center w-[42px] h-[54px] rounded-[14px] transition-all snap-center border-[1.5px] ${isSelected ? 'bg-sabah-blue border-sabah-blue text-white shadow-md scale-105' : 'bg-white/80 border-transparent text-gray-500'}">
                        <span class="text-[8px] font-bold uppercase ${isSelected ? 'text-white/80' : 'text-gray-400'}">${dayName}</span>
                        <span class="text-lg font-serif font-bold -mt-0.5">${dateObj.getDate()}</span>
                    </button>
                `;
            }).join('');

            // Render Itinerary Items
            let html = '';
            
            if (plan.flight) {
                const f = plan.flight;
                html += `
                <div class="bg-white/90 backdrop-blur-md rounded-[24px] p-5 shadow-card mb-4 border border-white/50 relative overflow-hidden">
                    <div class="absolute top-0 left-0 right-0 h-1.5 bg-gradient-to-r from-red-500 to-red-600"></div>
                    <div class="flex justify-between items-center mb-6 mt-1">
                        <div class="flex flex-col"><span class="text-4xl font-sans font-bold text-sabah-dark">${f.departureCode}</span><span class="text-2xl font-serif text-sabah-blue font-bold">${f.departureTime}</span></div>
                        <div class="flex flex-col items-center flex-1 px-4 text-gray-300"><i data-lucide="plane" class="transform -rotate-45 w-8 h-8 mb-2"></i><div class="w-full h-[1px] bg-gray-300 border-t border-dashed"></div></div>
                        <div class="flex flex-col items-end"><span class="text-4xl font-sans font-bold text-sabah-dark">${f.arrivalCode}</span><span class="text-2xl font-serif text-sabah-blue font-bold">${f.arrivalTime}</span></div>
                    </div>
                    <div class="flex items-center gap-2 bg-gray-50 p-2 rounded-xl">
                        <span class="text-xs font-bold text-sabah-dark">${f.airline}</span>
                        <span class="text-[10px] text-gray-400">${f.flightNumber}</span>
                    </div>
                </div>`;
            }

            html += `<div class="space-y-2 relative" id="itinerary-list">`;
            
            plan.items.forEach((item, index) => {
                const isEditing = appState.isEditingId === item.id;
                const typeColor = item.type === 'food' ? 'bg-sabah-orange' : item.type === 'relax' ? 'bg-sabah-green' : item.type === 'transport' ? 'bg-sabah-yellow text-sabah-dark' : 'bg-sabah-blue';
                const textColor = item.type === 'transport' ? 'text-sabah-dark' : 'text-white';
                
                // Image Logic: Show if editing OR if exists
                const showImage = isEditing || item.imageUrl;
                const imageHtml = showImage ? `
                    <div class="w-20 h-20 flex-shrink-0 rounded-2xl shadow-sm border border-white bg-gray-50 overflow-hidden relative cursor-pointer" onclick="${isEditing ? `triggerImageUpload('${item.id}')` : ''}">
                        ${item.imageUrl ? `<img src="${item.imageUrl}" class="w-full h-full object-cover pointer-events-none">` : `<div class="w-full h-full flex items-center justify-center text-gray-300"><i data-lucide="image"></i></div>`}
                        ${isEditing ? `<div class="absolute inset-0 bg-black/30 flex items-center justify-center text-white text-[10px]">æ›´æ›</div>` : ''}
                    </div>` : '';

                // Note Logic
                const noteHtml = (isEditing || item.notes) ? `
                    <div class="bg-white/50 p-3 rounded-xl border border-gray-100/50 mt-2 w-full">
                        ${isEditing 
                            ? `<textarea oninput="updateNote('${item.id}', this.value)" class="w-full text-xs bg-transparent outline-none resize-none h-16" placeholder="è¼¸å…¥å‚™è¨»...">${item.notes || ''}</textarea>` 
                            : `<p class="text-xs text-gray-500 font-serif">ğŸ’¡ ${item.notes}</p>`}
                    </div>` : '';

                // Progress Bar Logic (Hidden by default, shown via JS on press)
                const progressBarHtml = `<div id="progress-${item.id}" class="progress-bar-container w-0"></div>`;

                // Badge Logic
                const editBadge = isEditing ? `<div class="absolute top-2 right-2 bg-sabah-blue text-white text-[9px] px-2 py-0.5 rounded-full font-bold z-10">ç·¨è¼¯æ¨¡å¼</div>` : '';

                html += `
                <div class="item-row flex gap-4 group" draggable="true" data-id="${item.id}" data-index="${index}">
                    <div class="flex flex-col items-center pt-1">
                         <div class="w-12 h-12 rounded-[18px] flex items-center justify-center shadow-sm z-10 ${typeColor} ${textColor}">
                            <span class="text-[11px] font-bold font-serif tracking-wider">${item.time}</span>
                         </div>
                         ${(index < plan.items.length - 1) ? `<div class="h-full w-0.5 bg-gray-300/30 my-1"></div>` : ''}
                    </div>
                    
                    <div class="flex-1 bg-white/85 backdrop-blur-md rounded-[24px] p-5 shadow-card border ${isEditing ? 'border-sabah-blue ring-2 ring-sabah-blue/20' : 'border-white/40'} relative overflow-hidden transition-all select-none"
                         onmousedown="startLongPress('${item.id}')" ontouchstart="startLongPress('${item.id}')"
                         onmouseup="cancelLongPress()" ontouchend="cancelLongPress()" onmouseleave="cancelLongPress()">
                         
                         ${progressBarHtml}
                         ${editBadge}

                         <div class="flex gap-4">
                            <div class="drag-handle flex items-center justify-center text-gray-300 cursor-grab active:cursor-grabbing" onmousedown="event.stopPropagation()">
                                <i data-lucide="grip-vertical" width="16"></i>
                            </div>
                            <div class="flex-1">
                                <div class="flex items-center gap-1.5 text-gray-400 text-[10px] font-bold uppercase tracking-wider mb-1">
                                    <i data-lucide="clock" width="10"></i> ${item.type.toUpperCase()}
                                </div>
                                <h3 class="text-lg font-serif font-bold text-sabah-dark leading-tight mb-1">${item.activity}</h3>
                                <div class="flex items-center gap-1 text-xs text-gray-500">
                                    <i data-lucide="map-pin" width="12" class="text-sabah-blue"></i>
                                    <span>${item.location}</span>
                                </div>
                            </div>
                            ${imageHtml}
                         </div>
                         ${noteHtml}
                    </div>
                </div>`;

                // Travel Time
                if (item.travelTime && index < plan.items.length - 1) {
                    html += `
                    <div class="flex items-center gap-2 ml-[18px] h-10 border-l-[2px] border-dashed border-gray-300 pl-4 relative my-1">
                        <div class="absolute left-[-5px] top-1/2 -translate-y-1/2 w-2 h-2 rounded-full bg-gray-300"></div>
                        <div class="flex items-center gap-1.5 bg-white/70 backdrop-blur px-2 py-1 rounded-full border border-gray-100 shadow-sm">
                            <i data-lucide="arrow-down" width="10" class="text-gray-400"></i>
                            <span class="text-[10px] font-bold text-gray-500">${item.travelTime}</span>
                        </div>
                    </div>`;
                }
            });
            
            html += `</div>`;
            container.innerHTML = html;
            lucide.createIcons();
            setupDragAndDrop();
        }

        // --- Drag & Drop Logic (Native HTML5) ---
        function setupDragAndDrop() {
            const list = document.getElementById('itinerary-list');
            let draggedItem = null;
            let placeholder = document.createElement('div');
            placeholder.className = 'h-2 bg-sabah-blue/20 rounded my-2';

            list.querySelectorAll('.item-row').forEach(row => {
                row.addEventListener('dragstart', function(e) {
                    draggedItem = this;
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/html', this.innerHTML);
                    this.classList.add('dragging');
                    appState.isEditingId = null; // Exit edit mode
                    renderPlan(); // Re-render to clear edit, but need to re-grab ref... tricky. 
                    // To simplify vanilla logic: Just style the dragged item.
                });

                row.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                    if (this !== draggedItem) {
                        // Basic visual feedback
                        this.style.borderTop = '2px solid #0077BE';
                    }
                });
                
                row.addEventListener('dragleave', function() {
                    this.style.borderTop = '';
                });

                row.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.style.borderTop = '';
                    if (this !== draggedItem) {
                        const allRows = Array.from(list.querySelectorAll('.item-row'));
                        const fromIndex = allRows.indexOf(draggedItem);
                        const toIndex = allRows.indexOf(this);
                        
                        // Reorder Data
                        const plan = appState.dayPlans.find(d => d.date === appState.selectedDate);
                        const [movedItem] = plan.items.splice(fromIndex, 1);
                        plan.items.splice(toIndex, 0, movedItem);
                        
                        // Recalculate Time
                        recalculateSchedule(plan);
                        
                        renderPlan();
                    }
                });
                
                row.addEventListener('dragend', function() {
                    this.classList.remove('dragging');
                    list.querySelectorAll('.item-row').forEach(r => r.style.borderTop = '');
                });
            });
        }

        // --- Long Press Logic ---
        let pressTimer;
        let progressInterval;
        
        function startLongPress(id) {
            // If already editing this one, ignore
            if (appState.isEditingId === id) return;

            const bar = document.getElementById(`progress-${id}`);
            if(!bar) return;
            
            let width = 0;
            bar.style.width = '0%';
            
            progressInterval = setInterval(() => {
                width += 2.5; // 2.5% * 40 = 100% (approx 2s at 50ms interval)
                if(width > 100) width = 100;
                bar.style.width = width + '%';
            }, 50);

            pressTimer = setTimeout(() => {
                // Success
                clearInterval(progressInterval);
                bar.style.width = '0%';
                if (navigator.vibrate) navigator.vibrate(50);
                appState.isEditingId = id;
                renderPlan();
            }, 2000);
        }

        function cancelLongPress() {
            clearTimeout(pressTimer);
            clearInterval(progressInterval);
            const bars = document.querySelectorAll('.progress-bar-container');
            bars.forEach(b => b.style.width = '0%');
        }

        function selectDate(date) {
            appState.selectedDate = date;
            appState.isEditingId = null; // reset edit
            renderPlan();
        }

        function updateNote(id, text) {
            const plan = appState.dayPlans.find(d => d.date === appState.selectedDate);
            const item = plan.items.find(i => i.id === id);
            if (item) item.notes = text;
        }

        function triggerImageUpload(id) {
            const input = document.getElementById('image-upload-input');
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        const plan = appState.dayPlans.find(d => d.date === appState.selectedDate);
                        const item = plan.items.find(i => i.id === id);
                        if (item) item.imageUrl = ev.target.result;
                        renderPlan();
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }

        // MAP RENDERER
        function initMap() {
            document.getElementById('view-map').classList.remove('hidden');
            
            if (!appState.map) {
                appState.map = L.map('map-container').setView([LOCATIONS.JESSELTON_QUAY.lat, LOCATIONS.JESSELTON_QUAY.lng], 13);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                    attribution: 'Â© OpenStreetMap'
                }).addTo(appState.map);
            }
            
            // Clear existing layers (simple approach: remove all markers)
            appState.map.eachLayer((layer) => {
                if (layer instanceof L.Marker) {
                    appState.map.removeLayer(layer);
                }
            });

            const plan = appState.dayPlans.find(d => d.date === appState.selectedDate);
            const markers = [];

            // Add Accommodation
            const homeIcon = L.divIcon({ className: 'custom-house-icon', html: '<i data-lucide="home" width="18"></i>', iconSize: [32,32] });
            L.marker([LOCATIONS.JESSELTON_QUAY.lat, LOCATIONS.JESSELTON_QUAY.lng], { icon: homeIcon })
             .addTo(appState.map).bindPopup("<b>ä½å®¿: JQ</b>");

            // Add Day Items
            if (plan) {
                plan.items.forEach(item => {
                    const mk = L.marker([item.coords.lat, item.coords.lng])
                        .addTo(appState.map)
                        .bindPopup(`<b>${item.activity}</b><br>${item.location}`);
                    markers.push(mk);
                });
            }

            // Fit bounds
            if (markers.length) {
                const group = new L.featureGroup(markers);
                appState.map.fitBounds(group.getBounds().pad(0.2));
            }
            
            setTimeout(() => appState.map.invalidateSize(), 100); // Fix rendering issue
        }

        // WALLET RENDERER
        function renderWallet() {
            const container = document.getElementById('view-wallet');
            const total = appState.expenses.reduce((sum, e) => sum + e.amount, 0);
            
            container.innerHTML = `
                <div class="bg-sabah-dark rounded-[32px] p-6 text-white shadow-xl relative overflow-hidden mb-6">
                    <div class="absolute -top-10 -right-10 w-48 h-48 bg-sabah-blue rounded-full blur-3xl opacity-20"></div>
                    <div class="relative z-10">
                        <h2 class="text-gray-400 text-xs font-bold uppercase tracking-widest mb-2">ç¸½æ”¯å‡º (NT$)</h2>
                        <span class="text-4xl font-sans font-bold">${total.toLocaleString()}</span>
                    </div>
                </div>

                <form onsubmit="addExpense(event)" class="bg-white rounded-[24px] p-5 shadow-card mb-6">
                    <div class="bg-sabah-bg rounded-2xl p-4 mb-4 flex items-center gap-4">
                        <div class="flex-1">
                            <label class="text-[10px] font-bold text-gray-400 uppercase block mb-1">é‡‘é¡ (TWD)</label>
                            <input id="ex-amount" type="number" class="w-full bg-transparent text-2xl font-bold text-sabah-dark outline-none" placeholder="0" required>
                        </div>
                    </div>
                    <input id="ex-desc" type="text" class="w-full bg-white border-b-2 border-gray-100 p-3 text-sm mb-4 outline-none" placeholder="é …ç›®èªªæ˜" required>
                    <button type="submit" class="w-full bg-sabah-yellow text-sabah-dark font-bold py-4 rounded-xl shadow-lg flex items-center justify-center gap-2">
                        <i data-lucide="plus"></i> åŠ å…¥
                    </button>
                </form>

                <div class="space-y-3">
                    ${appState.expenses.slice().reverse().map(e => `
                        <div class="bg-white p-4 rounded-2xl shadow-card flex justify-between items-center">
                            <div>
                                <p class="font-bold text-sabah-dark">${e.desc}</p>
                                <p class="text-xs text-gray-400">${e.date}</p>
                            </div>
                            <span class="font-bold">NT$ ${e.amount}</span>
                        </div>
                    `).join('')}
                </div>
            `;
            lucide.createIcons();
        }

        function addExpense(e) {
            e.preventDefault();
            const amt = document.getElementById('ex-amount').value;
            const desc = document.getElementById('ex-desc').value;
            if (amt && desc) {
                appState.expenses.push({ 
                    id: Date.now(), 
                    amount: parseInt(amt), 
                    desc, 
                    date: new Date().toLocaleDateString() 
                });
                renderWallet();
            }
        }

        // SHOPPING RENDERER
        function renderShopping() {
            const container = document.getElementById('view-shopping');
            container.innerHTML = `
                <h2 class="text-3xl font-serif font-bold text-sabah-dark mb-6">å¿…è²·æ¸…å–®</h2>
                <div class="grid grid-cols-2 gap-4">
                    ${SHOPPING_ITEMS.map(item => `
                        <div class="bg-white/90 rounded-2xl p-3 shadow-card border border-white/50">
                            <div class="aspect-square bg-gray-100 rounded-xl mb-3 overflow-hidden">
                                <img src="${item.imageUrl}" class="w-full h-full object-cover">
                            </div>
                            <h4 class="font-bold text-sabah-dark text-xs mb-1">${item.name}</h4>
                            <div class="flex gap-1 text-sabah-yellow"><i data-lucide="star" width="12" fill="currentColor"></i><span class="text-[10px] font-bold text-gray-500">${item.rating}</span></div>
                        </div>
                    `).join('')}
                </div>
            `;
            lucide.createIcons();
        }

        // INFO RENDERER
        function renderInfo() {
            const container = document.getElementById('view-info');
            container.innerHTML = `
                 <h2 class="text-3xl font-serif font-bold text-sabah-dark mb-6">æ—…éŠè³‡è¨Š</h2>
                 <div class="bg-white p-5 rounded-[24px] shadow-card">
                    <div class="flex items-center gap-3 mb-3"><div class="p-2 bg-blue-50 text-blue-500 rounded-full"><i data-lucide="plug"></i></div><h3 class="font-bold">é›»å£“èˆ‡æ’åº§</h3></div>
                    <p class="text-sm text-gray-600">è‹±è¦ä¸‰å­” (Type G)ã€‚éœ€å¸¶è½‰æ¥é ­ã€‚</p>
                 </div>
                 <div class="bg-white p-5 rounded-[24px] shadow-card">
                    <div class="flex items-center gap-3 mb-3"><div class="p-2 bg-yellow-50 text-yellow-500 rounded-full"><i data-lucide="banknote"></i></div><h3 class="font-bold">æ›åŒ¯</h3></div>
                    <p class="text-sm text-gray-600">æ¨è–¦å¸‚å€ Wisma Merdekaï¼ŒåŒ¯ç‡æœ€ä½³ã€‚</p>
                 </div>
            `;
            lucide.createIcons();
        }

        // --- Init ---
        function renderApp() {
            document.getElementById('app-frame').classList.remove('hidden');
            switchTab('plan');
        }

        // Start
        window.onload = () => {
             // Simulate loading time then init
             // The splash screen handles the transition
        };

    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>
